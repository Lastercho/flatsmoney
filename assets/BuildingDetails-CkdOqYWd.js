import{r as n,j as e,a as H,u as J}from"./index-BfTOZOtM.js";import{i as c}from"./axios-D9plb12n.js";const K=({buildingId:o,onExpenseChange:d})=>{const[m,A]=n.useState([]),[N,k]=n.useState([]),[r,p]=n.useState({expense_type_id:"",amount:"",date:"",description:""}),[i,w]=n.useState(!0),[b,g]=n.useState(null);n.useEffect(()=>{o&&(x(),S())},[o]);const x=async()=>{try{const s=await c.get(`/buildings/${o}/expenses`);A(s.data),g(null)}catch(s){console.error("Грешка при зареждане на разходите:",s),g("Възникна грешка при зареждане на разходите")}finally{w(!1)}},S=async()=>{try{const s=await c.get("/expense-types");k(s.data),g(null)}catch(s){console.error("Грешка при зареждане на типовете разходи:",s),g("Възникна грешка при зареждане на типовете разходи")}},$=async s=>{s.preventDefault();try{await c.post(`/buildings/${o}/expenses`,r),p({expense_type_id:"",amount:"",date:"",description:""}),await x(),d&&d(),alert("Разходът е добавен успешно!")}catch(_){console.error("Грешка при добавяне на разход:",_),alert("Възникна грешка при добавяне на разхода")}},l=async s=>{if(window.confirm("Сигурни ли сте, че искате да изтриете този разход?"))try{await c.delete(`/buildings/${o}/expenses/${s}`),await x(),d&&d(),alert("Разходът е изтрит успешно!")}catch(_){console.error("Грешка при изтриване на разход:",_),alert("Възникна грешка при изтриване на разхода")}},y=s=>new Date(s).toLocaleDateString();return i?e.jsx("div",{className:"building-expenses",children:"Зареждане..."}):b?e.jsx("div",{className:"building-expenses error",children:b}):e.jsxs("div",{className:"building-expenses",children:[e.jsx("h2",{children:"Разходи на сградата"}),e.jsxs("form",{onSubmit:$,className:"expense-form",children:[e.jsxs("select",{value:r.expense_type_id,onChange:s=>p({...r,expense_type_id:s.target.value}),required:!0,children:[e.jsx("option",{value:"",children:"Изберете тип разход"}),N.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsx("input",{type:"number",placeholder:"Сума",value:r.amount,onChange:s=>p({...r,amount:s.target.value}),min:"0.01",step:"0.01",required:!0}),e.jsx("input",{type:"date",value:r.date,onChange:s=>p({...r,date:s.target.value}),required:!0}),e.jsx("input",{type:"text",placeholder:"Описание",value:r.description,onChange:s=>p({...r,description:s.target.value})}),e.jsx("button",{type:"submit",children:"Добави разход"})]}),e.jsx("div",{className:"expenses-list",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Дата"}),e.jsx("th",{children:"Тип разход"}),e.jsx("th",{children:"Сума"}),e.jsx("th",{children:"Описание"}),e.jsx("th",{children:"Действия"})]})}),e.jsx("tbody",{children:m.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:y(s.date)}),e.jsx("td",{children:s.expense_type_name}),e.jsxs("td",{children:[parseFloat(s.amount).toFixed(2)," лв."]}),e.jsx("td",{children:s.description}),e.jsx("td",{children:e.jsx("button",{onClick:()=>l(s.id),className:"delete-button",children:"Изтрий"})})]},s.id))})]})})]})},Q=({floorId:o,onDataChange:d})=>{const[m,A]=n.useState([]),[N,k]=n.useState(null),[r,p]=n.useState({apartment_number:"",owner_name:"",area:""}),[i,w]=n.useState(null),[b,g]=n.useState([]),[x,S]=n.useState([]),[$,l]=n.useState({amount:"",date:"",description:""}),[y,s]=n.useState({amount:"",due_date:"",description:""});n.useEffect(()=>{o&&(_(),D())},[o]),n.useEffect(()=>{i&&L()},[i]);const _=async()=>{try{const t=await c.get(`/floors/${o}/apartments`);A(t.data)}catch(t){console.error("Грешка при зареждане на апартаментите:",t)}},D=async()=>{try{const t=await c.get(`/floors/${o}`);k(t.data)}catch(t){console.error("Грешка при зареждане на информацията за етажа:",t)}},L=async()=>{try{const[t,j]=await Promise.all([c.get(`/apartments/${i.id}/deposits`),c.get(`/apartments/${i.id}/obligations`)]);g(t.data),S(j.data)}catch(t){console.error("Грешка при зареждане на депозити и задължения:",t)}},U=async t=>{var C,a,u,F;if(t.preventDefault(),!r.apartment_number.trim()){alert("Моля, въведете номер на апартамента");return}if(!r.owner_name.trim()){alert("Моля, въведете име на собственика");return}if(!r.area||parseFloat(r.area)<=0){alert("Моля, въведете валидна площ (положително число)");return}if(m.find(v=>v.apartment_number===r.apartment_number)){alert("Апартамент с този номер вече съществува на този етаж");return}try{await c.post(`/floors/${o}/apartments`,{...r,floor_id:o,apartment_number:r.apartment_number.trim(),owner_name:r.owner_name.trim(),area:parseFloat(r.area)}),p({apartment_number:"",owner_name:"",area:""}),await _()}catch(v){console.error("Грешка при добавяне на апартамент:",v),(a=(C=v.response)==null?void 0:C.data)!=null&&a.error?alert(v.response.data.error):((u=v.response)==null?void 0:u.status)===404?alert("Етажът не е намерен. Моля, опреснете страницата."):((F=v.response)==null?void 0:F.status)===409?alert("Апартамент с този номер вече съществува на този етаж"):alert("Възникна грешка при добавяне на апартамента!")}},R=async t=>{t.preventDefault();try{await c.post(`/apartments/${i.id}/deposits`,$),l({amount:"",date:"",description:""}),L(),d&&d()}catch(j){console.error("Грешка при добавяне на депозит:",j)}},W=async t=>{t.preventDefault();try{await c.post(`/apartments/${i.id}/obligations`,y),s({amount:"",due_date:"",description:""}),L(),d&&d()}catch(j){console.error("Грешка при добавяне на задължение:",j)}},z=async t=>{if(window.confirm("Сигурни ли сте, че искате да изтриете този депозит?"))try{await c.delete(`/apartments/${i.id}/deposits/${t}`),L(),d&&d()}catch(C){console.error("Грешка при изтриване на депозит:",C),alert("Възникна грешка при изтриване на депозита!")}},G=async t=>{if(window.confirm("Сигурни ли сте, че искате да изтриете това задължение?"))try{await c.delete(`/apartments/${i.id}/obligations/${t}`),L(),d&&d()}catch(C){console.error("Грешка при изтриване на задължение:",C),alert("Възникна грешка при изтриване на задължението!")}},T=async t=>{var C,a;if(window.confirm("Сигурни ли сте, че искате да изтриете този апартамент?"))try{const u=await c.delete(`/apartments/${t}`);alert(u.data.message),await _(),i&&i.id===t&&(w(null),g([]),S([]))}catch(u){console.error("Грешка при изтриване на апартамент:",u),(a=(C=u.response)==null?void 0:C.data)!=null&&a.error?alert(u.response.data.error):alert("Възникна грешка при изтриване на апартамента!")}};return o?e.jsxs("div",{className:"apartment-list",children:[e.jsxs("h2",{children:["Управление на апартаменти - Етаж ",N==null?void 0:N.floor_number]}),N&&m.length<N.total_apartments&&e.jsxs("form",{onSubmit:U,className:"apartment-form",children:[e.jsx("input",{type:"text",placeholder:"Номер на апартамент",value:r.apartment_number,onChange:t=>p({...r,apartment_number:t.target.value}),required:!0}),e.jsx("input",{type:"text",placeholder:"Име на собственика",value:r.owner_name,onChange:t=>p({...r,owner_name:t.target.value}),required:!0}),e.jsx("input",{type:"number",placeholder:"Площ (кв.м)",value:r.area,onChange:t=>p({...r,area:t.target.value}),min:"0.01",step:"0.01",required:!0}),e.jsx("button",{type:"submit",children:"Добави апартамент"})]}),e.jsx("div",{className:"apartments-grid",children:m.map(t=>e.jsxs("div",{className:`apartment-card ${(i==null?void 0:i.id)===t.id?"selected":""}`,onClick:()=>w(t),children:[e.jsxs("h3",{children:["Апартамент ",t.apartment_number]}),e.jsxs("p",{children:["Собственик: ",t.owner_name]}),e.jsxs("p",{children:["Площ: ",t.area," кв.м"]}),e.jsx("button",{onClick:j=>{j.stopPropagation(),T(t.id)},children:"Изтрий"})]},t.id))}),i&&e.jsxs("div",{className:"apartment-details",children:[e.jsxs("h3",{children:["Детайли за апартамент ",i.apartment_number]}),e.jsxs("div",{className:"deposits-section",children:[e.jsx("h4",{children:"Депозити"}),e.jsxs("form",{onSubmit:R,className:"deposit-form",children:[e.jsx("input",{type:"number",placeholder:"Сума",value:$.amount,onChange:t=>{l({...$,amount:t.target.value})}}),e.jsx("input",{type:"date",value:$.date,onChange:t=>l({...$,date:t.target.value})}),e.jsx("input",{type:"text",placeholder:"Описание",value:$.description,onChange:t=>l({...$,description:t.target.value})}),e.jsx("button",{type:"submit",children:"Добави депозит"})]}),e.jsx("div",{className:"deposits-list",children:b.map(t=>e.jsxs("div",{className:"deposit-item",children:[e.jsxs("p",{children:["Сума: ",t.amount," лв."]}),e.jsxs("p",{children:["Дата: ",new Date(t.date).toLocaleDateString()]}),e.jsxs("p",{children:["Описание: ",t.description]}),e.jsx("button",{onClick:j=>{j.stopPropagation(),z(t.id)},className:"delete-button",children:"Изтрий"})]},t.id))})]}),e.jsxs("div",{className:"obligations-section",children:[e.jsx("h4",{children:"Задължения"}),e.jsxs("form",{onSubmit:W,className:"obligation-form",children:[e.jsx("input",{type:"number",placeholder:"Сума",value:y.amount,onChange:t=>s({...y,amount:t.target.value})}),e.jsx("input",{type:"date",value:y.due_date,onChange:t=>s({...y,due_date:t.target.value})}),e.jsx("input",{type:"text",placeholder:"Описание",value:y.description,onChange:t=>s({...y,description:t.target.value})}),e.jsx("button",{type:"submit",children:"Добави задължение"})]}),e.jsx("div",{className:"obligations-list",children:x.filter(t=>!t.is_paid).map(t=>e.jsxs("div",{className:"obligation-item",children:[e.jsxs("p",{children:["Сума: ",t.amount," лв."]}),e.jsxs("p",{children:["Краен срок: ",new Date(t.due_date).toLocaleDateString()]}),e.jsxs("p",{children:["Описание: ",t.description]}),e.jsx("button",{onClick:j=>{j.stopPropagation(),G(t.id)},className:"delete-button",children:"Изтрий"})]},t.id))})]})]})]}):e.jsx("div",{className:"apartment-list",children:"Моля, изберете етаж"})},V=({buildingId:o,onFloorSelect:d})=>{const[m,A]=n.useState([]),[N,k]=n.useState(!0),[r,p]=n.useState(null),[i,w]=n.useState({floor_number:"",total_apartments:""});n.useEffect(()=>{o&&(g(),b())},[o]);const b=async()=>{try{const l=await c.get(`/buildings/${o}`);p(l.data)}catch(l){console.error("Грешка при зареждане на информацията за сградата:",l)}},g=async()=>{try{const l=await c.get(`/buildings/${o}/floors`);A(l.data)}catch(l){console.error("Грешка при зареждане на етажите:",l)}finally{k(!1)}},x=async l=>{var s,_;if(l.preventDefault(),!r){alert("Грешка: Информацията за сградата не е налична");return}if(m.length>=r.total_floors){alert(`Не можете да добавите повече етажи. Максималният брой етажи за тази сграда е ${r.total_floors}`);return}if(m.some(D=>D.floor_number===parseInt(i.floor_number)&&!D.is_deleted)){alert(`Етаж ${i.floor_number} вече съществува в тази сграда!`);return}try{const D={floor_number:parseInt(i.floor_number),total_apartments:parseInt(i.total_apartments)};await c.post(`/buildings/${o}/floors`,D),w({floor_number:"",total_apartments:""}),g()}catch(D){console.error("Грешка при добавяне на етаж:",D),(_=(s=D.response)==null?void 0:s.data)!=null&&_.error?alert(D.response.data.error):alert("Възникна грешка при добавяне на етаж!")}},S=async l=>{if(window.confirm("Сигурни ли сте, че искате да изтриете този етаж?"))try{await c.delete(`/floors/${l}`),g()}catch(s){console.error("Грешка при изтриване на етаж:",s),alert("Възникна грешка при изтриване на етаж!")}},$=l=>{d(l)};return N?e.jsx("div",{className:"floor-list",children:"Зареждане..."}):o?e.jsxs("div",{className:"floor-list",children:[e.jsx("h2",{children:"Управление на етажи"}),r&&m.length<r.total_floors&&e.jsxs("form",{onSubmit:x,className:"floor-form",children:[e.jsx("div",{className:"form-group",children:e.jsx("input",{type:"number",placeholder:"Номер на етаж",value:i.floor_number,onChange:l=>w({...i,floor_number:l.target.value}),required:!0})}),e.jsx("div",{className:"form-group",children:e.jsx("input",{type:"number",placeholder:"Брой апартаменти",value:i.total_apartments,onChange:l=>w({...i,total_apartments:l.target.value}),required:!0})}),e.jsx("button",{type:"submit",children:"Добави етаж"})]}),e.jsx("div",{className:"floors-grid",children:m.map(l=>e.jsxs("div",{className:"floor-card",onClick:()=>$(l),children:[e.jsxs("h3",{children:["Етаж ",l.floor_number]}),e.jsxs("p",{children:["Брой апартаменти: ",l.total_apartments]}),e.jsx("button",{className:"delete-button",onClick:y=>{y.stopPropagation(),S(l.id)},children:"Изтрий"})]},l.id))})]}):e.jsx("div",{className:"floor-list",children:"Моля, изберете сграда"})},X=({buildingId:o,onSuccess:d})=>{const[m,A]=n.useState({amount:"",due_date:"",description:""}),[N,k]=n.useState(!1),[r,p]=n.useState({text:"",type:""}),i=b=>{A({...m,[b.target.name]:b.target.value})},w=async b=>{var g,x;if(b.preventDefault(),!m.amount||!m.due_date||!m.description){p({text:"Моля, попълнете всички полета",type:"error"});return}try{k(!0);const S=await c.post(`/buildings/${o}/bulk-obligations`,m);k(!1),p({text:"Задълженията са добавени успешно!",type:"success"}),A({amount:"",due_date:"",description:""}),d&&typeof d=="function"&&d()}catch(S){k(!1),console.error("Грешка при добавяне на задължения:",S),p({text:((x=(g=S.response)==null?void 0:g.data)==null?void 0:x.message)||"Възникна грешка при добавяне на задълженията",type:"error"})}};return e.jsxs("div",{className:"bulk-obligations-container",children:[e.jsx("h3",{children:"Добавяне на задължение към всички апартаменти"}),r.text&&e.jsx("div",{className:`message ${r.type}`,children:r.text}),e.jsxs("form",{onSubmit:w,className:"bulk-obligations-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"amount",children:"Сума (лв.)"}),e.jsx("input",{type:"number",id:"amount",name:"amount",value:m.amount,onChange:i,placeholder:"Въведете сума",min:"0.01",step:"0.01",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"due_date",children:"Краен срок"}),e.jsx("input",{type:"date",id:"due_date",name:"due_date",value:m.due_date,onChange:i,required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"description",children:"Описание"}),e.jsx("input",{type:"text",id:"description",name:"description",value:m.description,onChange:i,placeholder:"Напр. Такса общи части, Ремонт покрив и т.н.",required:!0})]}),e.jsx("button",{type:"submit",className:"bulk-obligations-button",disabled:N,children:N?"Добавяне...":"Добави задължение към всички апартаменти"})]})]})},I=()=>{const{id:o}=H(),d=J(),[m,A]=n.useState([]),[N,k]=n.useState([]),[r,p]=n.useState(!0),[i,w]=n.useState(!1),[b,g]=n.useState({totalDeposits:0,totalObligations:0,totalExpenses:0,availableAmount:0}),[x,S]=n.useState(null),[$,l]=n.useState([]),[y,s]=n.useState(""),[_,D]=n.useState(null),[L,U]=n.useState(!1);n.useEffect(()=>{C()},[o]);const R=a=>{const u=parseFloat(a);return isNaN(u)?"0.00":u.toFixed(2)},W=async()=>{try{const a=await c.get(`/buildings/${o}/expenses`);return k(a.data),a.data}catch(a){return console.error("Грешка при зареждане на разходите:",a),[]}},z=async()=>{U(!L)},G=(a,u=[])=>{const F=a.reduce((h,q)=>{var O;return h+(((O=q.deposits)==null?void 0:O.reduce((M,B)=>M+(parseFloat(B.amount)||0),0))||0)},0),v=a.reduce((h,q)=>{var O;return h+(((O=q.obligations)==null?void 0:O.reduce((M,B)=>M+(B.is_paid?0:parseFloat(B.amount)||0),0))||0)},0),f=a.reduce((h,q)=>{var O;return h+(((O=q.obligations)==null?void 0:O.reduce((M,B)=>M+(B.is_paid&&parseFloat(B.amount)||0),0))||0)},0),E=u.reduce((h,q)=>h+(parseFloat(q.amount)||0),0),P=F+f-E;g({totalDeposits:F,totalObligations:v,totalExpenses:E,availableAmount:P})},T=async()=>{try{p(!0);const[a,u]=await Promise.all([c.get(`/buildings/${o}/floors`),W()]),v=a.data.map(h=>c.get(`/floors/${h.id}/apartments`)),E=(await Promise.all(v)).flatMap(h=>h.data),P=await Promise.all(E.map(async h=>{const[q,O]=await Promise.all([c.get(`/apartments/${h.id}/deposits`),c.get(`/apartments/${h.id}/obligations`)]);return{...h,deposits:q.data||[],obligations:O.data||[]}}));A(P),G(P,u)}catch(a){console.error("Грешка при зареждане на информацията:",a)}finally{p(!1)}},t=async(a,u,F)=>{try{const f=(await c.get(`/apartments/${a}/deposits`)).data,E=f.reduce((P,h)=>P+parseFloat(h.amount),0);if(E>=F){for(const h of f)await c.delete(`/apartments/${a}/deposits/${h.id}`);const P=E-F;P>0&&await c.post(`/apartments/${a}/deposits`,{amount:P,date:new Date().toISOString().split("T")[0],description:"Остатък след плащане на задължение"}),await c.put(`/obligations/${u}`,{is_paid:!0,is_paid_from_deposit:!0,payment_date:new Date().toISOString()})}else await c.put(`/obligations/${u}`,{is_paid:!0,is_paid_from_deposit:!1,payment_date:new Date().toISOString()});T()}catch(v){console.error("Грешка при плащане на задължение:",v),alert("Възникна грешка при плащане на задължението!")}},j=()=>{C()},C=async()=>{try{p(!0);const a=await c.get(`/buildings/${o}`);S(a.data);const u=await c.get(`/buildings/${o}/floors`);l(u.data),await T()}catch(a){console.error("Грешка при зареждане на детайли за сградата:",a),s("Възникна грешка при зареждане на детайли за сградата"),p(!1)}};return r?e.jsx("div",{className:"loading",children:"Зареждане..."}):y?e.jsx("div",{className:"error",children:y}):x?e.jsxs("div",{className:"building-details-container",children:[e.jsxs("div",{className:"building-header",children:[e.jsx("h2",{children:x.name}),e.jsxs("div",{className:"building-actions",children:[e.jsx("button",{className:"btn btn-edit",onClick:()=>d(`/buildings/${o}/edit`),children:"Редактирай"}),e.jsx("button",{className:"toggle-bulk-obligations",onClick:()=>w(!i),children:i?"Скрий":"Добави задължение към всички апартаменти"}),e.jsx("button",{className:"btn btn-back",onClick:()=>d("/buildings"),children:"Назад"})]}),i&&e.jsx(X,{buildingId:o,onSuccess:()=>{j(),w(!1)}})]}),e.jsxs("div",{className:"building-info-card",children:[e.jsxs("div",{className:"info-group",children:[e.jsx("label",{children:"Адрес:"}),e.jsx("p",{children:x.address})]}),e.jsxs("div",{className:"info-group",children:[e.jsx("label",{children:"Брой етажи:"}),e.jsx("p",{children:x.total_floors})]}),x.description&&e.jsxs("div",{className:"info-group",children:[e.jsx("label",{children:"Описание:"}),e.jsx("p",{children:x.description})]})]}),e.jsxs("div",{className:"summary-section",children:[e.jsx("h3",{children:"Обобщение"}),e.jsxs("div",{className:"summary-grid",children:[e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{children:"Общо депозити:"}),e.jsxs("span",{className:"amount",children:[R(b.totalDeposits)," лв."]})]}),e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{children:"Общо задължения:"}),e.jsxs("span",{className:"amount",children:[R(b.totalObligations)," лв."]})]}),e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{children:"Общо разходи:"}),e.jsxs("span",{className:"amount",children:[R(b.totalExpenses)," лв."]})]}),e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{children:"Налична сума:"}),e.jsxs("span",{className:"amount",children:[R(b.availableAmount)," лв."]})]})]})]}),e.jsxs("div",{className:"floors-section",children:[e.jsx("h3",{children:"Етажи"}),e.jsx(V,{buildingId:o,onFloorSelect:a=>D(a)})]}),_&&e.jsxs("div",{className:"apartments-section",children:[e.jsxs("h3",{children:["Апартаменти на етаж ",_.floor_number]}),e.jsx(Q,{floorId:_.id,onDataChange:T})]}),e.jsxs("div",{className:"apartments-section",children:[e.jsx("h3",{children:"Апартаменти"}),e.jsx("div",{className:"table-container",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Етаж"}),e.jsx("th",{children:"Апартамент №"}),e.jsx("th",{children:"Собственик"}),e.jsx("th",{children:"Площ (кв.м)"}),e.jsx("th",{children:"Депозити"}),e.jsx("th",{children:"Задължения"}),e.jsx("th",{children:"Действия"})]})}),e.jsx("tbody",{children:m.map(a=>{const u=a.deposits.reduce((f,E)=>f+parseFloat(E.amount||0),0),F=a.obligations.filter(f=>!f.is_paid),v=F.reduce((f,E)=>f+parseFloat(E.amount||0),0);return e.jsxs("tr",{children:[e.jsx("td",{children:a.floor_number}),e.jsx("td",{children:a.apartment_number}),e.jsx("td",{children:a.owner_name}),e.jsx("td",{children:a.area}),e.jsxs("td",{children:[R(u)," лв."]}),e.jsxs("td",{children:[R(v)," лв."]}),e.jsx("td",{children:F.map(f=>e.jsxs("button",{onClick:()=>{t(a.id,f.id,parseFloat(f.amount)),z()},className:"payment-button",children:["Плати ",R(f.amount)," лв.",e.jsx("br",{}),e.jsxs("small",{children:["Краен срок: ",new Date(f.due_date).toLocaleDateString()]})]},f.id))})]},a.id)})})]})})]}),e.jsx(K,{buildingId:o,onExpenseChange:()=>{T()}})]}):e.jsx("div",{className:"error",children:"Сградата не е намерена"})};export{I as default};
