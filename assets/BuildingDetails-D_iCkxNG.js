import{r as n,j as e,a as J,u as K}from"./index-DPZgPq3a.js";import{i as c}from"./axios-D9plb12n.js";const Q=({buildingId:o,onExpenseChange:d})=>{const[u,E]=n.useState([]),[w,F]=n.useState([]),[r,m]=n.useState({expense_type_id:"",amount:"",date:"",description:""}),[i,N]=n.useState(!0),[b,g]=n.useState(null);n.useEffect(()=>{o&&(h(),S())},[o]);const h=async()=>{try{const s=await c.get(`/buildings/${o}/expenses`);E(s.data),g(null)}catch(s){console.error("Грешка при зареждане на разходите:",s),g("Възникна грешка при зареждане на разходите")}finally{N(!1)}},S=async()=>{try{const s=await c.get("/expense-types");F(s.data),g(null)}catch(s){console.error("Грешка при зареждане на типовете разходи:",s),g("Възникна грешка при зареждане на типовете разходи")}},$=async s=>{s.preventDefault();try{await c.post(`/buildings/${o}/expenses`,r),m({expense_type_id:"",amount:"",date:"",description:""}),await h(),d&&d(),alert("Разходът е добавен успешно!")}catch(_){console.error("Грешка при добавяне на разход:",_),alert("Възникна грешка при добавяне на разхода")}},l=async s=>{if(window.confirm("Сигурни ли сте, че искате да изтриете този разход?"))try{await c.delete(`/buildings/${o}/expenses/${s}`),await h(),d&&d(),alert("Разходът е изтрит успешно!")}catch(_){console.error("Грешка при изтриване на разход:",_),alert("Възникна грешка при изтриване на разхода")}},y=s=>new Date(s).toLocaleDateString();return i?e.jsx("div",{className:"building-expenses",children:"Зареждане..."}):b?e.jsx("div",{className:"building-expenses error",children:b}):e.jsxs("div",{className:"building-expenses",children:[e.jsx("h2",{children:"Разходи на сградата"}),e.jsxs("form",{onSubmit:$,className:"expense-form",children:[e.jsxs("select",{value:r.expense_type_id,onChange:s=>m({...r,expense_type_id:s.target.value}),required:!0,children:[e.jsx("option",{value:"",children:"Изберете тип разход"}),w.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsx("input",{type:"number",placeholder:"Сума",value:r.amount,onChange:s=>m({...r,amount:s.target.value}),min:"0.01",step:"0.01",required:!0}),e.jsx("input",{type:"date",value:r.date,onChange:s=>m({...r,date:s.target.value}),required:!0}),e.jsx("input",{type:"text",placeholder:"Описание",value:r.description,onChange:s=>m({...r,description:s.target.value})}),e.jsx("button",{type:"submit",children:"Добави разход"})]}),e.jsx("div",{className:"expenses-list",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Дата"}),e.jsx("th",{children:"Тип разход"}),e.jsx("th",{children:"Сума"}),e.jsx("th",{children:"Описание"}),e.jsx("th",{children:"Действия"})]})}),e.jsx("tbody",{children:u.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:y(s.date)}),e.jsx("td",{children:s.expense_type_name}),e.jsxs("td",{children:[parseFloat(s.amount).toFixed(2)," лв."]}),e.jsx("td",{children:s.description}),e.jsx("td",{children:e.jsx("button",{onClick:()=>l(s.id),className:"delete-button",children:"Изтрий"})})]},s.id))})]})})]})},V=({floorId:o,onDataChange:d})=>{const[u,E]=n.useState([]),[w,F]=n.useState(null),[r,m]=n.useState({apartment_number:"",owner_name:"",area:""}),[i,N]=n.useState(null),[b,g]=n.useState([]),[h,S]=n.useState([]),[$,l]=n.useState({amount:"",date:"",description:""}),[y,s]=n.useState({amount:"",due_date:"",description:""});n.useEffect(()=>{o&&(_(),D())},[o]),n.useEffect(()=>{i&&L()},[i]);const _=async()=>{try{const t=await c.get(`/floors/${o}/apartments`);E(t.data)}catch(t){console.error("Грешка при зареждане на апартаментите:",t)}},D=async()=>{try{const t=await c.get(`/floors/${o}`);F(t.data)}catch(t){console.error("Грешка при зареждане на информацията за етажа:",t)}},L=async()=>{try{const[t,x]=await Promise.all([c.get(`/apartments/${i.id}/deposits`),c.get(`/apartments/${i.id}/obligations`)]);g(t.data),S(x.data)}catch(t){console.error("Грешка при зареждане на депозити и задължения:",t)}},W=async t=>{var C,B,a,v;if(t.preventDefault(),!r.apartment_number.trim()){alert("Моля, въведете номер на апартамента");return}if(!r.owner_name.trim()){alert("Моля, въведете име на собственика");return}if(!r.area||parseFloat(r.area)<=0){alert("Моля, въведете валидна площ (положително число)");return}if(u.find(f=>f.apartment_number===r.apartment_number)){alert("Апартамент с този номер вече съществува на този етаж");return}try{await c.post(`/floors/${o}/apartments`,{...r,floor_id:o,apartment_number:r.apartment_number.trim(),owner_name:r.owner_name.trim(),area:parseFloat(r.area)}),m({apartment_number:"",owner_name:"",area:""}),await _()}catch(f){console.error("Грешка при добавяне на апартамент:",f),(B=(C=f.response)==null?void 0:C.data)!=null&&B.error?alert(f.response.data.error):((a=f.response)==null?void 0:a.status)===404?alert("Етажът не е намерен. Моля, опреснете страницата."):((v=f.response)==null?void 0:v.status)===409?alert("Апартамент с този номер вече съществува на този етаж"):alert("Възникна грешка при добавяне на апартамента!")}},O=async t=>{t.preventDefault();try{await c.post(`/apartments/${i.id}/deposits`,$),l({amount:"",date:"",description:""}),L(),d&&d()}catch(x){console.error("Грешка при добавяне на депозит:",x)}},z=async t=>{t.preventDefault();try{await c.post(`/apartments/${i.id}/obligations`,y),s({amount:"",due_date:"",description:""}),L(),d&&d()}catch(x){console.error("Грешка при добавяне на задължение:",x)}},G=async t=>{if(window.confirm("Сигурни ли сте, че искате да изтриете този депозит?"))try{await c.delete(`/apartments/${i.id}/deposits/${t}`),L(),d&&d()}catch(C){console.error("Грешка при изтриване на депозит:",C),alert("Възникна грешка при изтриване на депозита!")}},H=async t=>{if(window.confirm("Сигурни ли сте, че искате да изтриете това задължение?"))try{await c.delete(`/apartments/${i.id}/obligations/${t}`),L(),d&&d()}catch(C){console.error("Грешка при изтриване на задължение:",C),alert("Възникна грешка при изтриване на задължението!")}},M=async t=>{var C,B;if(window.confirm("Сигурни ли сте, че искате да изтриете този апартамент?"))try{const a=await c.delete(`/apartments/${t}`);alert(a.data.message),await _(),i&&i.id===t&&(N(null),g([]),S([]))}catch(a){console.error("Грешка при изтриване на апартамент:",a),(B=(C=a.response)==null?void 0:C.data)!=null&&B.error?alert(a.response.data.error):alert("Възникна грешка при изтриване на апартамента!")}};return o?e.jsxs("div",{className:"apartment-list",children:[e.jsxs("h2",{children:["Управление на апартаменти - Етаж ",w==null?void 0:w.floor_number]}),w&&u.length<w.total_apartments&&e.jsxs("form",{onSubmit:W,className:"apartment-form",children:[e.jsx("input",{type:"text",placeholder:"Номер на апартамент",value:r.apartment_number,onChange:t=>m({...r,apartment_number:t.target.value}),required:!0}),e.jsx("input",{type:"text",placeholder:"Име на собственика",value:r.owner_name,onChange:t=>m({...r,owner_name:t.target.value}),required:!0}),e.jsx("input",{type:"number",placeholder:"Площ (кв.м)",value:r.area,onChange:t=>m({...r,area:t.target.value}),min:"0.01",step:"0.01",required:!0}),e.jsx("button",{type:"submit",children:"Добави апартамент"})]}),e.jsx("div",{className:"apartments-grid",children:u.map(t=>e.jsxs("div",{className:`apartment-card ${(i==null?void 0:i.id)===t.id?"selected":""}`,onClick:()=>N(t),children:[e.jsxs("h3",{children:["Апартамент ",t.apartment_number]}),e.jsxs("p",{children:["Собственик: ",t.owner_name]}),e.jsxs("p",{children:["Площ: ",t.area," кв.м"]}),e.jsx("button",{onClick:x=>{x.stopPropagation(),M(t.id)},children:"Изтрий"})]},t.id))}),i&&e.jsxs("div",{className:"apartment-details",children:[e.jsxs("h3",{children:["Детайли за апартамент ",i.apartment_number]}),e.jsxs("div",{className:"deposits-section",children:[e.jsx("h4",{children:"Депозити"}),e.jsxs("form",{onSubmit:O,className:"deposit-form",children:[e.jsx("input",{type:"number",placeholder:"Сума",value:$.amount,onChange:t=>{l({...$,amount:t.target.value})}}),e.jsx("input",{type:"date",value:$.date,onChange:t=>l({...$,date:t.target.value})}),e.jsx("input",{type:"text",placeholder:"Описание",value:$.description,onChange:t=>l({...$,description:t.target.value})}),e.jsx("button",{type:"submit",children:"Добави депозит"})]}),e.jsx("div",{className:"deposits-list",children:b.map(t=>e.jsxs("div",{className:"deposit-item",children:[e.jsxs("p",{children:["Сума: ",t.amount," лв."]}),e.jsxs("p",{children:["Дата: ",new Date(t.date).toLocaleDateString()]}),e.jsxs("p",{children:["Описание: ",t.description]}),e.jsx("button",{onClick:x=>{x.stopPropagation(),G(t.id)},className:"delete-button",children:"Изтрий"})]},t.id))})]}),e.jsxs("div",{className:"obligations-section",children:[e.jsx("h4",{children:"Задължения"}),e.jsxs("form",{onSubmit:z,className:"obligation-form",children:[e.jsx("input",{type:"number",placeholder:"Сума",value:y.amount,onChange:t=>s({...y,amount:t.target.value})}),e.jsx("input",{type:"date",value:y.due_date,onChange:t=>s({...y,due_date:t.target.value})}),e.jsx("input",{type:"text",placeholder:"Описание",value:y.description,onChange:t=>s({...y,description:t.target.value})}),e.jsx("button",{type:"submit",children:"Добави задължение"})]}),e.jsx("div",{className:"obligations-list",children:h.filter(t=>!t.is_paid).map(t=>e.jsxs("div",{className:"obligation-item",children:[e.jsxs("p",{children:["Сума: ",t.amount," лв."]}),e.jsxs("p",{children:["Краен срок: ",new Date(t.due_date).toLocaleDateString()]}),e.jsxs("p",{children:["Описание: ",t.description]}),e.jsx("button",{onClick:x=>{x.stopPropagation(),H(t.id)},className:"delete-button",children:"Изтрий"})]},t.id))})]})]})]}):e.jsx("div",{className:"apartment-list",children:"Моля, изберете етаж"})},X=({buildingId:o,onFloorSelect:d})=>{const[u,E]=n.useState([]),[w,F]=n.useState(!0),[r,m]=n.useState(null),[i,N]=n.useState({floor_number:"",total_apartments:""});n.useEffect(()=>{o&&(g(),b())},[o]);const b=async()=>{try{const l=await c.get(`/buildings/${o}`);m(l.data)}catch(l){console.error("Грешка при зареждане на информацията за сградата:",l)}},g=async()=>{try{const l=await c.get(`/buildings/${o}/floors`);E(l.data)}catch(l){console.error("Грешка при зареждане на етажите:",l)}finally{F(!1)}},h=async l=>{var s,_;if(l.preventDefault(),!r){alert("Грешка: Информацията за сградата не е налична");return}if(u.length>=r.total_floors){alert(`Не можете да добавите повече етажи. Максималният брой етажи за тази сграда е ${r.total_floors}`);return}if(u.some(D=>D.floor_number===parseInt(i.floor_number)&&!D.is_deleted)){alert(`Етаж ${i.floor_number} вече съществува в тази сграда!`);return}try{const D={floor_number:parseInt(i.floor_number),total_apartments:parseInt(i.total_apartments)};await c.post(`/buildings/${o}/floors`,D),N({floor_number:"",total_apartments:""}),g()}catch(D){console.error("Грешка при добавяне на етаж:",D),(_=(s=D.response)==null?void 0:s.data)!=null&&_.error?alert(D.response.data.error):alert("Възникна грешка при добавяне на етаж!")}},S=async l=>{if(window.confirm("Сигурни ли сте, че искате да изтриете този етаж?"))try{await c.delete(`/floors/${l}`),g()}catch(s){console.error("Грешка при изтриване на етаж:",s),alert("Възникна грешка при изтриване на етаж!")}},$=l=>{d(l)};return w?e.jsx("div",{className:"floor-list",children:"Зареждане..."}):o?e.jsxs("div",{className:"floor-list",children:[e.jsx("h2",{children:"Управление на етажи"}),r&&u.length<r.total_floors&&e.jsxs("form",{onSubmit:h,className:"floor-form",children:[e.jsx("div",{className:"form-group",children:e.jsx("input",{type:"number",placeholder:"Номер на етаж",value:i.floor_number,onChange:l=>N({...i,floor_number:l.target.value}),required:!0})}),e.jsx("div",{className:"form-group",children:e.jsx("input",{type:"number",placeholder:"Брой апартаменти",value:i.total_apartments,onChange:l=>N({...i,total_apartments:l.target.value}),required:!0})}),e.jsx("button",{type:"submit",children:"Добави етаж"})]}),e.jsx("div",{className:"floors-grid",children:u.map(l=>e.jsxs("div",{className:"floor-card",onClick:()=>$(l),children:[e.jsxs("h3",{children:["Етаж ",l.floor_number]}),e.jsxs("p",{children:["Брой апартаменти: ",l.total_apartments]}),e.jsx("button",{className:"delete-button",onClick:y=>{y.stopPropagation(),S(l.id)},children:"Изтрий"})]},l.id))})]}):e.jsx("div",{className:"floor-list",children:"Моля, изберете сграда"})},Y=({buildingId:o,onSuccess:d})=>{const[u,E]=n.useState({amount:"",due_date:"",description:""}),[w,F]=n.useState(!1),[r,m]=n.useState({text:"",type:""}),i=b=>{E({...u,[b.target.name]:b.target.value})},N=async b=>{var g,h;if(b.preventDefault(),!u.amount||!u.due_date||!u.description){m({text:"Моля, попълнете всички полета",type:"error"});return}try{F(!0);const S=await c.post(`/buildings/${o}/bulk-obligations`,u);F(!1),m({text:"Задълженията са добавени успешно!",type:"success"}),E({amount:"",due_date:"",description:""}),d&&typeof d=="function"&&d()}catch(S){F(!1),console.error("Грешка при добавяне на задължения:",S),m({text:((h=(g=S.response)==null?void 0:g.data)==null?void 0:h.message)||"Възникна грешка при добавяне на задълженията",type:"error"})}};return e.jsxs("div",{className:"bulk-obligations-container",children:[e.jsx("h3",{children:"Добавяне на задължение към всички апартаменти"}),r.text&&e.jsx("div",{className:`message ${r.type}`,children:r.text}),e.jsxs("form",{onSubmit:N,className:"bulk-obligations-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"amount",children:"Сума (лв.)"}),e.jsx("input",{type:"number",id:"amount",name:"amount",value:u.amount,onChange:i,placeholder:"Въведете сума",min:"0.01",step:"0.01",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"due_date",children:"Краен срок"}),e.jsx("input",{type:"date",id:"due_date",name:"due_date",value:u.due_date,onChange:i,required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"description",children:"Описание"}),e.jsx("input",{type:"text",id:"description",name:"description",value:u.description,onChange:i,placeholder:"Напр. Такса общи части, Ремонт покрив и т.н.",required:!0})]}),e.jsx("button",{type:"submit",className:"bulk-obligations-button",disabled:w,children:w?"Добавяне...":"Добави задължение към всички апартаменти"})]})]})},ee=()=>{const{id:o}=J(),d=K(),[u,E]=n.useState([]),[w,F]=n.useState([]),[r,m]=n.useState(!0),[i,N]=n.useState(!1),[b,g]=n.useState({totalDeposits:0,totalObligations:0,totalExpenses:0,availableAmount:0}),[h,S]=n.useState(null),[$,l]=n.useState([]),[y,s]=n.useState(""),[_,D]=n.useState(null),[L,W]=n.useState(!1);n.useEffect(()=>{C()},[o]);const O=a=>{const v=parseFloat(a);return isNaN(v)?"0.00":v.toFixed(2)},z=async()=>{try{const a=await c.get(`/buildings/${o}/expenses`);return F(a.data),a.data}catch(a){return console.error("Грешка при зареждане на разходите:",a),[]}},G=async()=>{W(!L)},H=(a,v=[])=>{const f=a.reduce((p,P)=>{var A;return p+(((A=P.deposits)==null?void 0:A.reduce((U,T)=>U+(parseFloat(T.amount)||0),0))||0)},0),q=a.reduce((p,P)=>{var A;return p+(((A=P.obligations)==null?void 0:A.reduce((U,T)=>U+(T.is_paid?0:parseFloat(T.amount)||0),0))||0)},0),j=a.reduce((p,P)=>{var A;return p+(((A=P.obligations)==null?void 0:A.reduce((U,T)=>U+(T.is_paid&&parseFloat(T.amount)||0),0))||0)},0),k=v.reduce((p,P)=>p+(parseFloat(P.amount)||0),0),R=f+j-k;g({totalDeposits:f,totalObligations:q,totalExpenses:k,availableAmount:R})},M=async()=>{try{m(!0);const[a,v]=await Promise.all([c.get(`/buildings/${o}/floors`),z()]),q=a.data.map(p=>c.get(`/floors/${p.id}/apartments`)),k=(await Promise.all(q)).flatMap(p=>p.data),R=await Promise.all(k.map(async p=>{const[P,A]=await Promise.all([c.get(`/apartments/${p.id}/deposits`),c.get(`/apartments/${p.id}/obligations`)]);return{...p,deposits:P.data||[],obligations:A.data||[]}}));E(R),H(R,v)}catch(a){console.error("Грешка при зареждане на информацията:",a)}finally{m(!1)}},t=async(a,v,f)=>{try{const j=(await c.get(`/apartments/${a}/deposits`)).data,k=j.reduce((R,p)=>R+parseFloat(p.amount),0);if(k>=f){for(const p of j)await c.delete(`/apartments/${a}/deposits/${p.id}`);const R=k-f;R>0&&await c.post(`/apartments/${a}/deposits`,{amount:R,date:new Date().toISOString().split("T")[0],description:"Остатък след плащане на задължение"}),await c.put(`/obligations/${v}`,{is_paid:!0,is_paid_from_deposit:!0,payment_date:new Date().toISOString()})}else await c.put(`/obligations/${v}`,{is_paid:!0,is_paid_from_deposit:!1,payment_date:new Date().toISOString()});M()}catch(q){console.error("Грешка при плащане на задължение:",q),alert("Възникна грешка при плащане на задължението!")}},x=()=>{C()},C=async()=>{try{m(!0);const a=await c.get(`/buildings/${o}`);S(a.data);const v=await c.get(`/buildings/${o}/floors`);l(v.data),await M()}catch(a){console.error("Грешка при зареждане на детайли за сградата:",a),s("Възникна грешка при зареждане на детайли за сградата"),m(!1)}},B=async()=>{if(window.confirm("Сигурни ли сте, че искате да изтриете тази сграда? Това действие е необратимо."))try{await c.delete(`/buildings/${o}`),d("/buildings")}catch(a){console.error("Грешка при изтриване на сградата:",a),s("Възникна грешка при изтриване на сградата")}};return r?e.jsx("div",{className:"loading",children:"Зареждане..."}):y?e.jsx("div",{className:"error",children:y}):h?e.jsxs("div",{className:"building-details-container",children:[e.jsxs("div",{className:"building-header",children:[e.jsx("h2",{children:h.name}),e.jsxs("div",{className:"building-actions",children:[e.jsx("button",{className:"btn btn-delete",onClick:B,children:"Изтрий сграда"}),e.jsx("button",{className:"toggle-bulk-obligations",onClick:()=>N(!i),children:i?"Скрий":"Добави задължение към всички апартаменти"}),e.jsx("button",{className:"btn btn-back",onClick:()=>d("/buildings"),children:"Назад"})]}),i&&e.jsx(Y,{buildingId:o,onSuccess:()=>{x(),N(!1)}})]}),e.jsxs("div",{className:"building-info-card",children:[e.jsxs("div",{className:"info-group",children:[e.jsx("label",{children:"Адрес:"}),e.jsx("p",{children:h.address})]}),e.jsxs("div",{className:"info-group",children:[e.jsx("label",{children:"Брой етажи:"}),e.jsx("p",{children:h.total_floors})]}),h.description&&e.jsxs("div",{className:"info-group",children:[e.jsx("label",{children:"Описание:"}),e.jsx("p",{children:h.description})]})]}),e.jsxs("div",{className:"summary-section",children:[e.jsx("h3",{children:"Обобщение"}),e.jsxs("div",{className:"summary-grid",children:[e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{children:"Общо депозити:"}),e.jsxs("span",{className:"amount",children:[O(b.totalDeposits)," лв."]})]}),e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{children:"Общо задължения:"}),e.jsxs("span",{className:"amount",children:[O(b.totalObligations)," лв."]})]}),e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{children:"Общо разходи:"}),e.jsxs("span",{className:"amount",children:[O(b.totalExpenses)," лв."]})]}),e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{children:"Налична сума:"}),e.jsxs("span",{className:"amount",children:[O(b.availableAmount)," лв."]})]})]})]}),e.jsxs("div",{className:"floors-section",children:[e.jsx("h3",{children:"Етажи"}),e.jsx(X,{buildingId:o,onFloorSelect:a=>D(a)})]}),_&&e.jsxs("div",{className:"apartments-section",children:[e.jsxs("h3",{children:["Апартаменти на етаж ",_.floor_number]}),e.jsx(V,{floorId:_.id,onDataChange:M})]}),e.jsxs("div",{className:"apartments-section",children:[e.jsx("h3",{children:"Апартаменти"}),e.jsx("div",{className:"table-container",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Етаж"}),e.jsx("th",{children:"Апартамент №"}),e.jsx("th",{children:"Собственик"}),e.jsx("th",{children:"Площ (кв.м)"}),e.jsx("th",{children:"Депозити"}),e.jsx("th",{children:"Задължения"}),e.jsx("th",{children:"Действия"})]})}),e.jsx("tbody",{children:u.map(a=>{const v=a.deposits.reduce((j,k)=>j+parseFloat(k.amount||0),0),f=a.obligations.filter(j=>!j.is_paid),q=f.reduce((j,k)=>j+parseFloat(k.amount||0),0);return e.jsxs("tr",{children:[e.jsx("td",{children:a.floor_number}),e.jsx("td",{children:a.apartment_number}),e.jsx("td",{children:a.owner_name}),e.jsx("td",{children:a.area}),e.jsxs("td",{children:[O(v)," лв."]}),e.jsxs("td",{children:[O(q)," лв."]}),e.jsx("td",{children:f.map(j=>e.jsxs("button",{onClick:()=>{t(a.id,j.id,parseFloat(j.amount)),G()},className:"payment-button",children:["Плати ",O(j.amount)," лв.",e.jsx("br",{}),e.jsxs("small",{children:["Краен срок: ",new Date(j.due_date).toLocaleDateString()]})]},j.id))})]},a.id)})})]})})]}),e.jsx(Q,{buildingId:o,onExpenseChange:()=>{M()}})]}):e.jsx("div",{className:"error",children:"Сградата не е намерена"})};export{ee as default};
