var ls=Object.defineProperty;var cs=(n,t,e)=>t in n?ls(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var L=(n,t,e)=>cs(n,typeof t!="symbol"?t+"":t,e);import{u as fs,r as X,j as k}from"./index-R8q6hdM5.js";function hs(n){return n!==null?{comment:n,variations:[]}:{variations:[]}}function us(n,t,e,s,i){const o={move:n,variations:i};return t&&(o.suffix=t),e&&(o.nag=e),s!==null&&(o.comment=s),o}function ps(...n){const[t,...e]=n;let s=t;for(const i of e)i!==null&&(s.variations=[i,...i.variations],i.variations=[],s=i);return t}function ds(n,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){const s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:n,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function gs(n,t){function e(){this.constructor=n}e.prototype=t.prototype,n.prototype=new e}function pe(n,t,e,s){var i=Error.call(this,n);return Object.setPrototypeOf&&Object.setPrototypeOf(i,pe.prototype),i.expected=t,i.found=e,i.location=s,i.name="SyntaxError",i}gs(pe,Error);function Le(n,t,e){return e=e||" ",n.length>t?n:(t-=n.length,e+=e.repeat(t),n+e.slice(0,t))}pe.prototype.format=function(n){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<n.length;s++)if(n[s].source===this.location.source){e=n[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,o=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,u=this.location.source+":"+o.line+":"+o.column;if(e){var f=this.location.end,h=Le("",o.line.toString().length," "),p=e[i.line-1],_=i.line===f.line?f.column:p.length+1,S=_-i.column||1;t+=`
 --> `+u+`
`+h+` |
`+o.line+" | "+p+`
`+h+" | "+Le("",i.column-1," ")+Le("",S,"^")}else t+=`
 at `+u}return t};pe.buildMessage=function(n,t){var e={literal:function(p){return'"'+i(p.text)+'"'},class:function(p){var _=p.parts.map(function(S){return Array.isArray(S)?o(S[0])+"-"+o(S[1]):o(S)});return"["+(p.inverted?"^":"")+_.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(p){return p.description}};function s(p){return p.charCodeAt(0).toString(16).toUpperCase()}function i(p){return p.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(_){return"\\x0"+s(_)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(_){return"\\x"+s(_)})}function o(p){return p.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(_){return"\\x0"+s(_)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(_){return"\\x"+s(_)})}function u(p){return e[p.type](p)}function f(p){var _=p.map(u),S,d;if(_.sort(),_.length>0){for(S=1,d=1;S<_.length;S++)_[S-1]!==_[S]&&(_[d]=_[S],d++);_.length=d}switch(_.length){case 1:return _[0];case 2:return _[0]+" or "+_[1];default:return _.slice(0,-1).join(", ")+", or "+_[_.length-1]}}function h(p){return p?'"'+i(p)+'"':"end of input"}return"Expected "+f(n)+" but "+h(t)+" found."};function _s(n,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,i={pgn:et},o=et,u="[",f='"',h="]",p=".",_="O-O-O",S="O-O",d="0-0-0",M="0-0",m="$",x="{",T="}",j=";",ne="(",te=")",Se="1-0",oe="0-1",Ee="1/2-1/2",Ie="*",ge=/^[a-zA-Z]/,ye=/^[^"]/,he=/^[0-9]/,N=/^[.]/,A=/^[a-zA-Z1-8\-=]/,P=/^[+#]/,I=/^[!?]/,K=/^[^}]/,V=/^[^\r\n]/,Q=/^[ \t\r\n]/,$=Y("tag pair"),F=D("[",!1),O=D('"',!1),z=D("]",!1),ae=Y("tag name"),G=ee([["a","z"],["A","Z"]],!1,!1),pt=Y("tag value"),He=ee(['"'],!0,!1),dt=Y("move number"),Ce=ee([["0","9"]],!1,!1),gt=D(".",!1),Ge=ee(["."],!1,!1),_t=Y("standard algebraic notation"),mt=D("O-O-O",!1),vt=D("O-O",!1),bt=D("0-0-0",!1),St=D("0-0",!1),We=ee([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Et=ee(["+","#"],!1,!1),yt=Y("suffix annotation"),Ve=ee(["!","?"],!1,!1),Ct=Y("NAG"),kt=D("$",!1),At=Y("brace comment"),$t=D("{",!1),Je=ee(["}"],!0,!1),wt=D("}",!1),Nt=Y("rest of line comment"),xt=D(";",!1),Ye=ee(["\r",`
`],!0,!1),Tt=Y("variation"),Pt=D("(",!1),It=D(")",!1),Ot=Y("game termination marker"),Lt=D("1-0",!1),Mt=D("0-1",!1),Kt=D("1/2-1/2",!1),Rt=D("*",!1),Ft=Y("whitespace"),ze=ee([" ","	","\r",`
`],!1,!1),qt=function(r,l){return ds(r,l)},Dt=function(r){return Object.fromEntries(r)},Ut=function(r,l){return[r,l]},jt=function(r,l){return{root:r,marker:l}},Bt=function(r,l){return ps(hs(r),...l.flat())},Qt=function(r,l,c,b,E){return us(r,l,c,b,E)},Ht=function(r){return r},Gt=function(r){return r.replace(/[\r\n]+/g," ")},Wt=function(r){return r.trim()},Vt=function(r){return r},Jt=function(r,l){return{result:r,comment:l}},a=t.peg$currPos|0,ue=[{line:1,column:1}],Z=a,ke=t.peg$maxFailExpected||[],g=t.peg$silentFails|0,_e;if(t.startRule){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');o=i[t.startRule]}function D(r,l){return{type:"literal",text:r,ignoreCase:l}}function ee(r,l,c){return{type:"class",parts:r,inverted:l,ignoreCase:c}}function Yt(){return{type:"end"}}function Y(r){return{type:"other",description:r}}function Ze(r){var l=ue[r],c;if(l)return l;if(r>=ue.length)c=ue.length-1;else for(c=r;!ue[--c];);for(l=ue[c],l={line:l.line,column:l.column};c<r;)n.charCodeAt(c)===10?(l.line++,l.column=1):l.column++,c++;return ue[r]=l,l}function Xe(r,l,c){var b=Ze(r),E=Ze(l),w={source:s,start:{offset:r,line:b.line,column:b.column},end:{offset:l,line:E.line,column:E.column}};return w}function v(r){a<Z||(a>Z&&(Z=a,ke=[]),ke.push(r))}function zt(r,l,c){return new pe(pe.buildMessage(r,l),r,l,c)}function et(){var r,l,c;return r=a,l=Zt(),c=ts(),r=qt(l,c),r}function Zt(){var r,l,c;for(r=a,l=[],c=tt();c!==e;)l.push(c),c=tt();return c=W(),r=Dt(l),r}function tt(){var r,l,c,b,E,w,le;return g++,r=a,W(),n.charCodeAt(a)===91?(l=u,a++):(l=e,g===0&&v(F)),l!==e?(W(),c=Xt(),c!==e?(W(),n.charCodeAt(a)===34?(b=f,a++):(b=e,g===0&&v(O)),b!==e?(E=es(),n.charCodeAt(a)===34?(w=f,a++):(w=e,g===0&&v(O)),w!==e?(W(),n.charCodeAt(a)===93?(le=h,a++):(le=e,g===0&&v(z)),le!==e?r=Ut(c,E):(a=r,r=e)):(a=r,r=e)):(a=r,r=e)):(a=r,r=e)):(a=r,r=e),g--,r===e&&g===0&&v($),r}function Xt(){var r,l,c;if(g++,r=a,l=[],c=n.charAt(a),ge.test(c)?a++:(c=e,g===0&&v(G)),c!==e)for(;c!==e;)l.push(c),c=n.charAt(a),ge.test(c)?a++:(c=e,g===0&&v(G));else l=e;return l!==e?r=n.substring(r,a):r=l,g--,r===e&&(l=e,g===0&&v(ae)),r}function es(){var r,l,c;for(g++,r=a,l=[],c=n.charAt(a),ye.test(c)?a++:(c=e,g===0&&v(He));c!==e;)l.push(c),c=n.charAt(a),ye.test(c)?a++:(c=e,g===0&&v(He));return r=n.substring(r,a),g--,l=e,g===0&&v(pt),r}function ts(){var r,l,c;return r=a,l=st(),W(),c=as(),c===e&&(c=null),W(),r=jt(l,c),r}function st(){var r,l,c,b;for(r=a,l=Oe(),l===e&&(l=null),c=[],b=rt();b!==e;)c.push(b),b=rt();return r=Bt(l,c),r}function rt(){var r,l,c,b,E,w,le,Ae;if(r=a,W(),ss(),W(),l=rs(),l!==e){for(c=is(),c===e&&(c=null),b=[],E=it();E!==e;)b.push(E),E=it();for(E=W(),w=Oe(),w===e&&(w=null),le=[],Ae=nt();Ae!==e;)le.push(Ae),Ae=nt();r=Qt(l,c,b,w,le)}else a=r,r=e;return r}function ss(){var r,l,c,b,E,w;for(g++,r=a,l=[],c=n.charAt(a),he.test(c)?a++:(c=e,g===0&&v(Ce));c!==e;)l.push(c),c=n.charAt(a),he.test(c)?a++:(c=e,g===0&&v(Ce));if(n.charCodeAt(a)===46?(c=p,a++):(c=e,g===0&&v(gt)),c!==e){for(b=W(),E=[],w=n.charAt(a),N.test(w)?a++:(w=e,g===0&&v(Ge));w!==e;)E.push(w),w=n.charAt(a),N.test(w)?a++:(w=e,g===0&&v(Ge));l=[l,c,b,E],r=l}else a=r,r=e;return g--,r===e&&(l=e,g===0&&v(dt)),r}function rs(){var r,l,c,b,E,w;if(g++,r=a,l=a,n.substr(a,5)===_?(c=_,a+=5):(c=e,g===0&&v(mt)),c===e&&(n.substr(a,3)===S?(c=S,a+=3):(c=e,g===0&&v(vt)),c===e&&(n.substr(a,5)===d?(c=d,a+=5):(c=e,g===0&&v(bt)),c===e&&(n.substr(a,3)===M?(c=M,a+=3):(c=e,g===0&&v(St)),c===e))))if(c=a,b=n.charAt(a),ge.test(b)?a++:(b=e,g===0&&v(G)),b!==e){if(E=[],w=n.charAt(a),A.test(w)?a++:(w=e,g===0&&v(We)),w!==e)for(;w!==e;)E.push(w),w=n.charAt(a),A.test(w)?a++:(w=e,g===0&&v(We));else E=e;E!==e?(b=[b,E],c=b):(a=c,c=e)}else a=c,c=e;return c!==e?(b=n.charAt(a),P.test(b)?a++:(b=e,g===0&&v(Et)),b===e&&(b=null),c=[c,b],l=c):(a=l,l=e),l!==e?r=n.substring(r,a):r=l,g--,r===e&&(l=e,g===0&&v(_t)),r}function is(){var r,l,c;for(g++,r=a,l=[],c=n.charAt(a),I.test(c)?a++:(c=e,g===0&&v(Ve));c!==e;)l.push(c),l.length>=2?c=e:(c=n.charAt(a),I.test(c)?a++:(c=e,g===0&&v(Ve)));return l.length<1?(a=r,r=e):r=l,g--,r===e&&(l=e,g===0&&v(yt)),r}function it(){var r,l,c,b,E;if(g++,r=a,W(),n.charCodeAt(a)===36?(l=m,a++):(l=e,g===0&&v(kt)),l!==e){if(c=a,b=[],E=n.charAt(a),he.test(E)?a++:(E=e,g===0&&v(Ce)),E!==e)for(;E!==e;)b.push(E),E=n.charAt(a),he.test(E)?a++:(E=e,g===0&&v(Ce));else b=e;b!==e?c=n.substring(c,a):c=b,c!==e?r=Ht(c):(a=r,r=e)}else a=r,r=e;return g--,r===e&&g===0&&v(Ct),r}function Oe(){var r;return r=ns(),r===e&&(r=os()),r}function ns(){var r,l,c,b,E;if(g++,r=a,n.charCodeAt(a)===123?(l=x,a++):(l=e,g===0&&v($t)),l!==e){for(c=a,b=[],E=n.charAt(a),K.test(E)?a++:(E=e,g===0&&v(Je));E!==e;)b.push(E),E=n.charAt(a),K.test(E)?a++:(E=e,g===0&&v(Je));c=n.substring(c,a),n.charCodeAt(a)===125?(b=T,a++):(b=e,g===0&&v(wt)),b!==e?r=Gt(c):(a=r,r=e)}else a=r,r=e;return g--,r===e&&(l=e,g===0&&v(At)),r}function os(){var r,l,c,b,E;if(g++,r=a,n.charCodeAt(a)===59?(l=j,a++):(l=e,g===0&&v(xt)),l!==e){for(c=a,b=[],E=n.charAt(a),V.test(E)?a++:(E=e,g===0&&v(Ye));E!==e;)b.push(E),E=n.charAt(a),V.test(E)?a++:(E=e,g===0&&v(Ye));c=n.substring(c,a),r=Wt(c)}else a=r,r=e;return g--,r===e&&(l=e,g===0&&v(Nt)),r}function nt(){var r,l,c,b;return g++,r=a,W(),n.charCodeAt(a)===40?(l=ne,a++):(l=e,g===0&&v(Pt)),l!==e?(c=st(),c!==e?(W(),n.charCodeAt(a)===41?(b=te,a++):(b=e,g===0&&v(It)),b!==e?r=Vt(c):(a=r,r=e)):(a=r,r=e)):(a=r,r=e),g--,r===e&&g===0&&v(Tt),r}function as(){var r,l,c;return g++,r=a,n.substr(a,3)===Se?(l=Se,a+=3):(l=e,g===0&&v(Lt)),l===e&&(n.substr(a,3)===oe?(l=oe,a+=3):(l=e,g===0&&v(Mt)),l===e&&(n.substr(a,7)===Ee?(l=Ee,a+=7):(l=e,g===0&&v(Kt)),l===e&&(n.charCodeAt(a)===42?(l=Ie,a++):(l=e,g===0&&v(Rt))))),l!==e?(W(),c=Oe(),c===e&&(c=null),r=Jt(l,c)):(a=r,r=e),g--,r===e&&(l=e,g===0&&v(Ot)),r}function W(){var r,l;for(g++,r=[],l=n.charAt(a),Q.test(l)?a++:(l=e,g===0&&v(ze));l!==e;)r.push(l),l=n.charAt(a),Q.test(l)?a++:(l=e,g===0&&v(ze));return g--,l=e,g===0&&v(Ft),r}if(_e=o(),t.peg$library)return{peg$result:_e,peg$currPos:a,peg$FAILED:e,peg$maxFailExpected:ke,peg$maxFailPos:Z};if(_e!==e&&a===n.length)return _e;throw _e!==e&&a<n.length&&v(Yt()),zt(ke,Z<n.length?n.charAt(Z):null,Z<n.length?Xe(Z,Z+1):Xe(Z,Z))}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const xe=0xffffffffffffffffn;function Me(n,t){return(n<<t|n>>64n-t)&0xffffffffffffffffn}function ot(n,t){return n*t&xe}function ms(n){return function(){let t=BigInt(n&xe),e=BigInt(n>>64n&xe);const s=ot(Me(ot(t,5n),7n),9n);return e^=t,t=(Me(t,24n)^e^e<<16n)&xe,e=Me(e,37n),n=e<<64n|t,s}}const Pe=ms(0xa187eb39cdcaed8f31c4b365b102e01en),vs=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>Pe()))),bs=Array.from({length:8},()=>Pe()),Ss=Array.from({length:16},()=>Pe()),Ke=Pe(),H="w",J="b",R="p",Be="n",Te="b",ve="r",ie="q",q="k",Re="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class $e{constructor(t,e){L(this,"color");L(this,"from");L(this,"to");L(this,"piece");L(this,"captured");L(this,"promotion");L(this,"flags");L(this,"san");L(this,"lan");L(this,"before");L(this,"after");const{color:s,piece:i,from:o,to:u,flags:f,captured:h,promotion:p}=e,_=U(o),S=U(u);this.color=s,this.piece=i,this.from=_,this.to=S,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=_+S,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(const d in C)C[d]&f&&(this.flags+=ce[d]);h&&(this.captured=h),p&&(this.promotion=p,this.lan+=p)}isCapture(){return this.flags.indexOf(ce.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(ce.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(ce.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(ce.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(ce.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(ce.BIG_PAWN)>-1}}const B=-1,ce={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},C={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},Qe={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Es={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},ys={...Qe,...Es},y={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},Fe={b:[16,32,17,15],w:[-16,-32,-17,-15]},at={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Cs=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],ks=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],As={p:1,n:2,b:4,r:8,q:16,k:32},$s="pnbrqkPNBRQK",lt=[Be,Te,ve,ie],ws=7,Ns=6,xs=1,Ts=0,we={[q]:C.KSIDE_CASTLE,[ie]:C.QSIDE_CASTLE},se={w:[{square:y.a1,flag:C.QSIDE_CASTLE},{square:y.h1,flag:C.KSIDE_CASTLE}],b:[{square:y.a8,flag:C.QSIDE_CASTLE},{square:y.h8,flag:C.KSIDE_CASTLE}]},Ps={b:xs,w:Ns},qe="--";function fe(n){return n>>4}function be(n){return n&15}function ut(n){return"0123456789".indexOf(n)!==-1}function U(n){const t=be(n),e=fe(n);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function me(n){return n===H?J:H}function Is(n){const t=n.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let u=0;u<i.length;u++){let f=0,h=!1;for(let p=0;p<i[u].length;p++)if(ut(i[u][p])){if(h)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};f+=parseInt(i[u][p],10),h=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[u][p]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};f+=1,h=!1}if(f!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const o=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:u,regex:f}of o){if(!f.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${u} king`};if((t[0].match(f)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${u} kings`}}return Array.from(i[0]+i[7]).some(u=>u.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Os(n,t){const e=n.from,s=n.to,i=n.piece;let o=0,u=0,f=0;for(let h=0,p=t.length;h<p;h++){const _=t[h].from,S=t[h].to,d=t[h].piece;i===d&&e!==_&&s===S&&(o++,fe(e)===fe(_)&&u++,be(e)===be(_)&&f++)}return o>0?u>0&&f>0?U(e):f>0?U(e).charAt(1):U(e).charAt(0):""}function re(n,t,e,s,i,o=void 0,u=C.NORMAL){const f=fe(s);if(i===R&&(f===ws||f===Ts))for(let h=0;h<lt.length;h++){const p=lt[h];n.push({color:t,from:e,to:s,piece:i,captured:o,promotion:p,flags:u|C.PROMOTION})}else n.push({color:t,from:e,to:s,piece:i,captured:o,flags:u})}function ct(n){let t=n.charAt(0);return t>="a"&&t<="h"?n.match(/[a-h]\d.*[a-h]\d/)?void 0:R:(t=t.toLowerCase(),t==="o"?q:t)}function De(n){return n.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class Ue{constructor(t=Re,{skipValidation:e=!1}={}){L(this,"_board",new Array(128));L(this,"_turn",H);L(this,"_header",{});L(this,"_kings",{w:B,b:B});L(this,"_epSquare",-1);L(this,"_halfMoves",0);L(this,"_moveNumber",0);L(this,"_history",[]);L(this,"_comments",{});L(this,"_castling",{w:0,b:0});L(this,"_hash",0n);L(this,"_positionCount",new Map);this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:B,b:B},this._turn=H,this._castling={w:0,b:0},this._epSquare=B,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...ys},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let i=t.split(/\s+/);if(i.length>=2&&i.length<6){const f=["-","-","0","1"];t=i.concat(f.slice(-(6-i.length))).join(" ")}if(i=t.split(/\s+/),!e){const{ok:f,error:h}=Is(t);if(!f)throw new Error(h)}const o=i[0];let u=0;this.clear({preserveHeaders:s});for(let f=0;f<o.length;f++){const h=o.charAt(f);if(h==="/")u+=8;else if(ut(h))u+=parseInt(h,10);else{const p=h<"a"?H:J;this._put({type:h.toLowerCase(),color:p},U(u)),u++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=C.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=C.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=C.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=C.QSIDE_CASTLE),this._epSquare=i[3]==="-"?B:y[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){var u,f;let e=0,s="";for(let h=y.a8;h<=y.h1;h++){if(this._board[h]){e>0&&(s+=e,e=0);const{color:p,type:_}=this._board[h];s+=p===H?_.toUpperCase():_.toLowerCase()}else e++;h+1&136&&(e>0&&(s+=e),h!==y.h1&&(s+="/"),e=0,h+=8)}let i="";this._castling[H]&C.KSIDE_CASTLE&&(i+="K"),this._castling[H]&C.QSIDE_CASTLE&&(i+="Q"),this._castling[J]&C.KSIDE_CASTLE&&(i+="k"),this._castling[J]&C.QSIDE_CASTLE&&(i+="q"),i=i||"-";let o="-";if(this._epSquare!==B)if(t)o=U(this._epSquare);else{const h=this._epSquare+(this._turn===H?16:-16),p=[h+1,h-1];for(const _ of p){if(_&136)continue;const S=this._turn;if(((u=this._board[_])==null?void 0:u.color)===S&&((f=this._board[_])==null?void 0:f.type)===R){this._makeMove({color:S,from:_,to:this._epSquare,piece:R,captured:R,flags:C.EP_CAPTURE});const d=!this._isKingAttacked(S);if(this._undoMove(),d){o=U(this._epSquare);break}}}}return[s,this._turn,i,o,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:e,type:s}=this._board[t],i={w:0,b:1}[e],o={p:0,n:1,b:2,r:3,q:4,k:5}[s];return vs[i][o][t]}_epKey(){return this._epSquare===B?0n:bs[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return Ss[t]}_computeHash(){let t=0n;for(let e=y.a8;e<=y.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=Ke),t}_updateSetup(t){this._history.length>0||(t!==Re?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(Re)}get(t){return this._board[y[t]]}findPiece(t){var s;const e=[];for(let i=y.a8;i<=y.h1;i++){if(i&136){i+=7;continue}!this._board[i]||((s=this._board[i])==null?void 0:s.color)!==t.color||this._board[i].color===t.color&&this._board[i].type===t.type&&e.push(U(i))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if($s.indexOf(t.toLowerCase())===-1||!(s in y))return!1;const i=y[s];if(t==q&&!(this._kings[e]==B||this._kings[e]==i))return!1;const o=this._board[i];return o&&o.type===q&&(this._kings[o.color]=B),this._set(i,{type:t,color:e}),t===q&&(this._kings[e]=i),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const e=this.get(t);return this._clear(y[t]),e&&e.type===q&&(this._kings[e.color]=B),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){var s,i,o,u,f,h,p,_,S,d,M,m;this._hash^=this._castlingKey();const t=((s=this._board[y.e1])==null?void 0:s.type)===q&&((i=this._board[y.e1])==null?void 0:i.color)===H,e=((o=this._board[y.e8])==null?void 0:o.type)===q&&((u=this._board[y.e8])==null?void 0:u.color)===J;(!t||((f=this._board[y.a1])==null?void 0:f.type)!==ve||((h=this._board[y.a1])==null?void 0:h.color)!==H)&&(this._castling.w&=-65),(!t||((p=this._board[y.h1])==null?void 0:p.type)!==ve||((_=this._board[y.h1])==null?void 0:_.color)!==H)&&(this._castling.w&=-33),(!e||((S=this._board[y.a8])==null?void 0:S.type)!==ve||((d=this._board[y.a8])==null?void 0:d.color)!==J)&&(this._castling.b&=-65),(!e||((M=this._board[y.h8])==null?void 0:M.type)!==ve||((m=this._board[y.h8])==null?void 0:m.color)!==J)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){var o,u;if(this._epSquare===B)return;const t=this._epSquare+(this._turn===H?-16:16),e=this._epSquare+(this._turn===H?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||((o=this._board[e])==null?void 0:o.color)!==me(this._turn)||((u=this._board[e])==null?void 0:u.type)!==R){this._hash^=this._epKey(),this._epSquare=B;return}const i=f=>{var h,p;return!(f&136)&&((h=this._board[f])==null?void 0:h.color)===this._turn&&((p=this._board[f])==null?void 0:p.type)===R};s.some(i)||(this._hash^=this._epKey(),this._epSquare=B)}_attacked(t,e,s){const i=[];for(let o=y.a8;o<=y.h1;o++){if(o&136){o+=7;continue}if(this._board[o]===void 0||this._board[o].color!==t)continue;const u=this._board[o],f=o-e;if(f===0)continue;const h=f+119;if(Cs[h]&As[u.type]){if(u.type===R){if(f>0&&u.color===H||f<=0&&u.color===J)if(s)i.push(U(o));else return!0;continue}if(u.type==="n"||u.type==="k")if(s){i.push(U(o));continue}else return!0;const p=ks[h];let _=o+p,S=!1;for(;_!==e;){if(this._board[_]!=null){S=!0;break}_+=p}if(!S)if(s){i.push(U(o));continue}else return!0}}return s?i:!1}attackers(t,e){return e?this._attacked(e,y[t],!0):this._attacked(this._turn,y[t],!0)}_isKingAttacked(t){const e=this._kings[t];return e===-1?!1:this._attacked(me(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,y[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},e=[];let s=0,i=0;for(let o=y.a8;o<=y.h1;o++){if(i=(i+1)%2,o&136){o+=7;continue}const u=this._board[o];u&&(t[u.type]=u.type in t?t[u.type]+1:1,u.type===Te&&e.push(i),s++)}if(s===2)return!0;if(s===3&&(t[Te]===1||t[Be]===1))return!0;if(s===t[Te]+2){let o=0;const u=e.length;for(let f=0;f<u;f++)o+=e[f];if(o===0||o===u)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){const i=this._moves({square:e,piece:s});return t?i.map(o=>new $e(this,o)):i.map(o=>this._moveToSan(o,i))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){var M;const i=s?s.toLowerCase():void 0,o=e==null?void 0:e.toLowerCase(),u=[],f=this._turn,h=me(f);let p=y.a8,_=y.h1,S=!1;if(i)if(i in y)p=_=y[i],S=!0;else return[];for(let m=p;m<=_;m++){if(m&136){m+=7;continue}if(!this._board[m]||this._board[m].color===h)continue;const{type:x}=this._board[m];let T;if(x===R){if(o&&o!==x)continue;T=m+Fe[f][0],this._board[T]||(re(u,f,m,T,R),T=m+Fe[f][1],Ps[f]===fe(m)&&!this._board[T]&&re(u,f,m,T,R,void 0,C.BIG_PAWN));for(let j=2;j<4;j++)T=m+Fe[f][j],!(T&136)&&(((M=this._board[T])==null?void 0:M.color)===h?re(u,f,m,T,R,this._board[T].type,C.CAPTURE):T===this._epSquare&&re(u,f,m,T,R,R,C.EP_CAPTURE))}else{if(o&&o!==x)continue;for(let j=0,ne=at[x].length;j<ne;j++){const te=at[x][j];for(T=m;T+=te,!(T&136);){if(!this._board[T])re(u,f,m,T,x);else{if(this._board[T].color===f)break;re(u,f,m,T,x,this._board[T].type,C.CAPTURE);break}if(x===Be||x===q)break}}}}if((o===void 0||o===q)&&(!S||_===this._kings[f])){if(this._castling[f]&C.KSIDE_CASTLE){const m=this._kings[f],x=m+2;!this._board[m+1]&&!this._board[x]&&!this._attacked(h,this._kings[f])&&!this._attacked(h,m+1)&&!this._attacked(h,x)&&re(u,f,this._kings[f],x,q,void 0,C.KSIDE_CASTLE)}if(this._castling[f]&C.QSIDE_CASTLE){const m=this._kings[f],x=m-2;!this._board[m-1]&&!this._board[m-2]&&!this._board[m-3]&&!this._attacked(h,this._kings[f])&&!this._attacked(h,m-1)&&!this._attacked(h,x)&&re(u,f,this._kings[f],x,q,void 0,C.QSIDE_CASTLE)}}if(!t||this._kings[f]===-1)return u;const d=[];for(let m=0,x=u.length;m<x;m++)this._makeMove(u[m]),this._isKingAttacked(f)||d.push(u[m]),this._undoMove();return d}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(qe,e);else if(typeof t=="object"){const o=this._moves();for(let u=0,f=o.length;u<f;u++)if(t.from===U(o[u].from)&&t.to===U(o[u].to)&&(!("promotion"in o[u])||t.promotion===o[u].promotion)){s=o[u];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&C.NULL_MOVE)throw new Error("Null move not allowed when in check");const i=new $e(this,s);return this._makeMove(s),this._incPositionCount(),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){var i,o,u,f;const e=this._turn,s=me(e);if(this._push(t),t.flags&C.NULL_MOVE){e===J&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=B;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&C.EP_CAPTURE&&(this._turn===J?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===q){if(this._kings[e]=t.to,t.flags&C.KSIDE_CASTLE){const h=t.to-1,p=t.to+1;this._movePiece(p,h)}else if(t.flags&C.QSIDE_CASTLE){const h=t.to+1,p=t.to-2;this._movePiece(p,h)}this._castling[e]=0}if(this._castling[e]){for(let h=0,p=se[e].length;h<p;h++)if(t.from===se[e][h].square&&this._castling[e]&se[e][h].flag){this._castling[e]^=se[e][h].flag;break}}if(this._castling[s]){for(let h=0,p=se[s].length;h<p;h++)if(t.to===se[s][h].square&&this._castling[s]&se[s][h].flag){this._castling[s]^=se[s][h].flag;break}}if(this._hash^=this._castlingKey(),t.flags&C.BIG_PAWN){let h;e===J?h=t.to-16:h=t.to+16,!(t.to-1&136)&&((i=this._board[t.to-1])==null?void 0:i.type)===R&&((o=this._board[t.to-1])==null?void 0:o.color)===s||!(t.to+1&136)&&((u=this._board[t.to+1])==null?void 0:u.type)===R&&((f=this._board[t.to+1])==null?void 0:f.color)===s?(this._epSquare=h,this._hash^=this._epKey()):this._epSquare=B}else this._epSquare=B;t.piece===R?this._halfMoves=0:t.flags&(C.CAPTURE|C.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===J&&this._moveNumber++,this._turn=s,this._hash^=Ke}undo(){const t=this._hash,e=this._undoMove();if(e){const s=new $e(this,e);return this._decPositionCount(t),s}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=Ke;const s=this._turn,i=me(s);if(e.flags&C.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&C.EP_CAPTURE){let o;s===J?o=e.to-16:o=e.to+16,this._set(o,{type:R,color:i})}else this._set(e.to,{type:e.captured,color:i});if(e.flags&(C.KSIDE_CASTLE|C.QSIDE_CASTLE)){let o,u;e.flags&C.KSIDE_CASTLE?(o=e.to+1,u=e.to-1):(o=e.to-2,u=e.to+1),this._movePiece(u,o)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){const s=[];let i=!1;for(const d in this._header)this._header[d]&&s.push(`[${d} "${this._header[d]}"]`+t),i=!0;i&&this._history.length&&s.push(t);const o=d=>{const M=this._comments[this.fen()];if(typeof M<"u"){const m=d.length>0?" ":"";d=`${d}${m}{${M}}`}return d},u=[];for(;this._history.length>0;)u.push(this._undoMove());const f=[];let h="";for(u.length===0&&f.push(o(""));u.length>0;){h=o(h);const d=u.pop();if(!d)break;if(!this._history.length&&d.color==="b"){const M=`${this._moveNumber}. ...`;h=h?`${h} ${M}`:M}else d.color==="w"&&(h.length&&f.push(h),h=this._moveNumber+".");h=h+" "+this._moveToSan(d,this._moves({legal:!0})),this._makeMove(d)}if(h.length&&f.push(o(h)),f.push(this._header.Result||"*"),e===0)return s.join("")+f.join(" ");const p=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},_=function(d,M){for(const m of M.split(" "))if(m){if(d+m.length>e){for(;p();)d--;s.push(t),d=0}s.push(m),d+=m.length,s.push(" "),d++}return p()&&d--,d};let S=0;for(let d=0;d<f.length;d++){if(S+f[d].length>e&&f[d].includes("{")){S=_(S,f[d]);continue}S+f[d].length>e&&d!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),S=0):d!==0&&(s.push(" "),S++),s.push(f[d]),S+=f[d].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??Qe[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=Qe[t]||null,!0):!1}getHeaders(){const t={};for(const[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));const i=_s(t);this.reset();const o=i.headers;let u="";for(const p in o)p.toLowerCase()==="fen"&&(u=o[p]),this.header(p,o[p]);if(!e)u&&this.load(u,{preserveHeaders:!0});else if(o.SetUp==="1"){if(!("FEN"in o))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(o.FEN,{preserveHeaders:!0})}let f=i.root;for(;f;){if(f.move){const p=this._moveFromSan(f.move,e);if(p==null)throw new Error(`Invalid move in PGN: ${f.move}`);this._makeMove(p),this._incPositionCount()}f.comment!==void 0&&(this._comments[this.fen()]=f.comment),f=f.variations[0]}const h=i.result;h&&Object.keys(this._header).length&&this._header.Result!==h&&this.setHeader("Result",h)}_moveToSan(t,e){let s="";if(t.flags&C.KSIDE_CASTLE)s="O-O";else if(t.flags&C.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&C.NULL_MOVE)return qe;if(t.piece!==R){const i=Os(t,e);s+=t.piece.toUpperCase()+i}t.flags&(C.CAPTURE|C.EP_CAPTURE)&&(t.piece===R&&(s+=U(t.from)[0]),s+="x"),s+=U(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=De(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==qe)return{color:this._turn,from:0,to:0,piece:"k",flags:C.NULL_MOVE};let i=ct(s),o=this._moves({legal:!0,piece:i});for(let d=0,M=o.length;d<M;d++)if(s===De(this._moveToSan(o[d],o)))return o[d];if(e)return null;let u,f,h,p,_,S=!1;if(f=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),f?(u=f[1],h=f[2],p=f[3],_=f[4],h.length==1&&(S=!0)):(f=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),f&&(u=f[1],h=f[2],p=f[3],_=f[4],h.length==1&&(S=!0))),i=ct(s),o=this._moves({legal:!0,piece:u||i}),!p)return null;for(let d=0,M=o.length;d<M;d++)if(h){if((!u||u.toLowerCase()==o[d].piece)&&y[h]==o[d].from&&y[p]==o[d].to&&(!_||_.toLowerCase()==o[d].promotion))return o[d];if(S){const m=U(o[d].from);if((!u||u.toLowerCase()==o[d].piece)&&y[p]==o[d].to&&(h==m[0]||h==m[1])&&(!_||_.toLowerCase()==o[d].promotion))return o[d]}}else if(s===De(this._moveToSan(o[d],o)).replace("x",""))return o[d];return null}ascii(){let t=`   +------------------------+
`;for(let e=y.a8;e<=y.h1;e++){if(be(e)===0&&(t+=" "+"87654321"[fe(e)]+" |"),this._board[e]){const s=this._board[e].type,o=this._board[e].color===H?s.toUpperCase():s.toLowerCase();t+=" "+o+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const e=this._moves({legal:!1});let s=0;const i=this._turn;for(let o=0,u=e.length;o<u;o++)this._makeMove(e[o]),this._isKingAttacked(i)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let e=[];for(let s=y.a8;s<=y.h1;s++)this._board[s]==null?e.push(null):e.push({square:U(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in y){const e=y[t];return(fe(e)+be(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){const i=e.pop();if(!i)break;t?s.push(new $e(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){const t=[],e={},s=i=>{i in this._comments&&(e[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){const i=t.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(const i of[q,ie])e[i]!==void 0&&(e[i]?this._castling[t]|=we[i]:this._castling[t]&=~we[i]);this._updateCastlingRights();const s=this.getCastlingRights(t);return(e[q]===void 0||e[q]===s[q])&&(e[ie]===void 0||e[ie]===s[ie])}getCastlingRights(t){return{[q]:(this._castling[t]&we[q])!==0,[ie]:(this._castling[t]&we[ie])!==0}}moveNumber(){return this._moveNumber}}const Ls="start";function Ms(n){try{return btoa(unescape(encodeURIComponent(n))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}catch{return""}}function Ks(n){try{let t=(n||"").replace(/-/g,"+").replace(/_/g,"/");const e=t.length%4;return e&&(t+="=".repeat(4-e)),decodeURIComponent(escape(atob(t)))}catch{return""}}const Ne={p:"♟",r:"♜",n:"♞",b:"♝",q:"♛",k:"♚",P:"♙",R:"♖",N:"♘",B:"♗",Q:"♕",K:"♔"},Rs={p:"пешка",n:"кон",b:"офицер",r:"топ",q:"дама",k:"цар"};function Fs(){try{const n=JSON.parse(localStorage.getItem("user"));return(n==null?void 0:n.id)||(n==null?void 0:n._id)||null}catch{return null}}function de(){const n=Fs();return n?`chess_state_${n}`:"chess_state_guest"}function qs(){const n=localStorage.getItem(de());if(!n)return null;try{const t=JSON.parse(n);return(t==null?void 0:t.fen)||null}catch{return null}}function je(n){try{localStorage.setItem(de(),JSON.stringify({fen:n,savedAt:Date.now()}))}catch(t){console.warn("Cannot save chess state:",t)}}function Ds(){localStorage.removeItem(de())}function ft(n){try{const t=de()+"_lastmove";if(n){const e={from:n.from,to:n.to,san:n.san,captured:n.captured||null};localStorage.setItem(t,JSON.stringify(e))}else localStorage.removeItem(t)}catch(t){console.warn("Cannot save last move:",t)}}function Us(){try{const n=de()+"_lastmove",t=localStorage.getItem(n);return t?JSON.parse(t):null}catch{return null}}function ht(){try{localStorage.removeItem(de()+"_lastmove")}catch{}}const Qs=()=>{const n="game",t=fs(),[e,s]=X.useState(()=>new Ue),[i,o]=X.useState(null),[u,f]=X.useState([]),[h,p]=X.useState("w"),[_,S]=X.useState(""),[d,M]=X.useState(!1),[m,x]=X.useState(null),T=X.useRef(null),j=N=>{const A={fen:N,t:Date.now()},P=Ms(JSON.stringify(A)),I=new URL(window.location.href);return I.searchParams.set(n,P),I.toString()},[ne,te]=X.useState("");X.useEffect(()=>{const N=new Ue,P=new URL(window.location.href).searchParams.get(n);let I=null;if(P){const Q=Ks(P);try{const $=JSON.parse(Q);$!=null&&$.fen&&(I=$.fen)}catch{console.warn("Invalid game URL payload")}}const K=qs(),V=I||K;try{V&&V!==Ls&&N.load(V)}catch{console.warn("Invalid saved chess FEN. Starting new game.")}if(s(N),p(N.turn()),oe(N),x(Us()),je(N.fen()),te(j(N.fen())),!P){const Q=j(N.fen());window.history.replaceState({},"",Q)}},[]);const Se=X.useMemo(()=>e.board(),[e,h]),oe=N=>{const A=N.isCheckmate(),P=N.isDraw();M(A||P),A?S(`Шах-мат! ${N.turn()==="w"?"Черните":"Белите"} печелят.`):P?S("Равенство."):N.isCheck()?S(`${N.turn()==="w"?"Бели":"Черни"} са на ход — Шах!`):S(`${N.turn()==="w"?"Бели":"Черни"} са на ход.`)},Ee=(N,A)=>{const P="abcdefgh"[N],I=8-A,K=`${P}${I}`;if(!i){const $=e.get(K);if($&&$.color===e.turn()){const F=e.moves({square:K,verbose:!0});o(K);let O=F.map(z=>z.to);try{if($.type==="k"){const z=F.some(G=>G.flags&&G.flags.includes("k")),ae=F.some(G=>G.flags&&G.flags.includes("q"));$.color==="w"?(z&&(O=Array.from(new Set([...O,"h1"]))),ae&&(O=Array.from(new Set([...O,"a1"])))):(z&&(O=Array.from(new Set([...O,"h8"]))),ae&&(O=Array.from(new Set([...O,"a8"]))))}}catch{}f(O)}else o(null),f([]);return}if(i===K){o(null),f([]);return}let V=K;try{const $=e.get(i),F=e.get(K);$&&$.type==="k"&&F&&F.color===$.color&&F.type==="r"&&($.color==="w"?(K==="h1"&&(V="g1"),K==="a1"&&(V="c1")):(K==="h8"&&(V="g8"),K==="a8"&&(V="c8")))}catch{}const Q=e.move({from:i,to:V,promotion:"q"});if(Q){o(null),f([]),p(e.turn());const $={from:Q.from,to:Q.to,san:Q.san,captured:Q.captured||null};x($),ft($);const F=e.fen();je(F),te(j(F)),window.history.replaceState({},"",j(F)),oe(e)}else{const $=e.get(K);if($&&$.color===e.turn()){const F=e.moves({square:K,verbose:!0});o(K);let O=F.map(z=>z.to);try{if($.type==="k"){const z=F.some(G=>G.flags&&G.flags.includes("k")),ae=F.some(G=>G.flags&&G.flags.includes("q"));$.color==="w"?(z&&(O=Array.from(new Set([...O,"h1"]))),ae&&(O=Array.from(new Set([...O,"a1"])))):(z&&(O=Array.from(new Set([...O,"h8"]))),ae&&(O=Array.from(new Set([...O,"a8"]))))}}catch{}f(O)}else o(null),f([])}},Ie=()=>{if(!window.confirm("Сигурни ли сте, че искате да рестартирате играта?"))return;const A=new Ue;s(A),p(A.turn()),o(null),f([]),x(null),ht(),Ds(),oe(A),new URL(window.location.href).searchParams.delete(n);const I=j(A.fen());te(I),window.history.replaceState({},"",I)},ge=()=>{if(!e.undo())return;o(null),f([]),p(e.turn());const A=e.history({verbose:!0});if(A.length>0){const I=A[A.length-1],K={from:I.from,to:I.to,san:I.san,captured:I.captured||null};x(K),ft(K)}else x(null),ht();const P=e.fen();je(P),te(j(P)),window.history.replaceState({},"",j(P)),oe(e)},ye=async()=>{try{await navigator.clipboard.writeText(ne),alert("Линкът е копиран в клипборда!")}catch{try{const A=document.createElement("textarea");A.value=ne,document.body.appendChild(A),A.select(),document.execCommand("copy"),document.body.removeChild(A),alert("Линкът е копиран в клипборда!")}catch{alert("Копирането не бе успешно. Моля, копирайте ръчно.")}}},he=()=>t("/home");return k.jsxs("div",{className:"chess-page",children:[k.jsxs("div",{className:"chess-header",children:[k.jsx("h2",{children:"Шах"}),k.jsxs("div",{className:"chess-actions",children:[k.jsx("button",{className:"btn-secondary",onClick:he,children:"← Назад"}),k.jsx("button",{className:"btn-secondary",onClick:ge,disabled:e.history().length===0,title:"Отмени последния ход",children:"↶ Отмени ход"}),k.jsx("button",{className:"btn-danger",onClick:Ie,children:"Рестартирай"})]})]}),k.jsxs("div",{className:"chess-container",children:[k.jsx("div",{className:"board",ref:T,children:Se.map((N,A)=>k.jsx("div",{className:"rank",children:N.map((P,I)=>{const K=(A+I)%2===1,V="abcdefgh"[I],Q=8-A,$=`${V}${Q}`,F=i===$,O=u.includes($);return k.jsxs("div",{className:`square ${K?"dark":"light"} ${F?"selected":""} ${O?"legal":""} ${m&&(m.from===$||m.to===$)?"last-move":""}`,onClick:()=>Ee(I,A),children:[P&&k.jsx("span",{className:`piece ${P.color==="w"?"white":"black"}`,children:Ne[P.type===P.type.toLowerCase(),P.type]||Ne[P.type]||""}),I===0&&k.jsx("div",{className:"coord rank-label",children:Q}),A===7&&k.jsx("div",{className:"coord file-label",children:"abcdefgh"[I]})]},I)})},A))}),k.jsxs("div",{className:"side-panel",children:[k.jsxs("div",{className:"status-card",children:[k.jsx("h3",{children:"Статус"}),k.jsx("p",{children:_}),d&&k.jsx("p",{className:"game-over",children:"Играта е приключила."})]}),k.jsxs("div",{className:"status-card",children:[k.jsx("h3",{children:"Последен ход"}),m?k.jsxs(k.Fragment,{children:[k.jsxs("p",{children:[k.jsx("strong",{children:m.san})," (",m.from,"→",m.to,")"]}),m.captured?k.jsxs("p",{children:["Взета фигура: ",Rs[m.captured]||m.captured,Ne[m.captured]?` (${Ne[m.captured]})`:""]}):null]}):k.jsx("p",{children:"Все още няма ход."})]}),k.jsxs("div",{className:"status-card",children:[k.jsx("h3",{children:"Продължи на друг браузър"}),k.jsx("p",{children:"Използвайте този линк, за да отворите играта на друг браузър/устройство (без бекенд):"}),k.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center"},children:[k.jsx("input",{type:"text",readOnly:!0,value:ne,onFocus:N=>N.target.select(),style:{flex:1,padding:"8px",borderRadius:"8px",border:"1px solid #ddd"}}),k.jsx("button",{className:"btn-secondary",onClick:ye,title:"Копирай линка",children:"Копирай"})]}),k.jsx("small",{children:"Линкът се обновява автоматично след всеки ход."})]})]})]})]})};export{Qs as default};
