var os=Object.defineProperty;var as=(n,t,e)=>t in n?os(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var T=(n,t,e)=>as(n,typeof t!="symbol"?t+"":t,e);import{u as ls,r as Y,j as A}from"./index-BhcDlnPk.js";function cs(n){return n!==null?{comment:n,variations:[]}:{variations:[]}}function hs(n,t,e,s,r){const o={move:n,variations:r};return t&&(o.suffix=t),e&&(o.nag=e),s!==null&&(o.comment=s),o}function fs(...n){const[t,...e]=n;let s=t;for(const r of e)r!==null&&(s.variations=[r,...r.variations],r.variations=[],s=r);return t}function us(n,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){const s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:n,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function ps(n,t){function e(){this.constructor=n}e.prototype=t.prototype,n.prototype=new e}function oe(n,t,e,s){var r=Error.call(this,n);return Object.setPrototypeOf&&Object.setPrototypeOf(r,oe.prototype),r.expected=t,r.found=e,r.location=s,r.name="SyntaxError",r}ps(oe,Error);function Ne(n,t,e){return e=e||" ",n.length>t?n:(t-=n.length,e+=e.repeat(t),n+e.slice(0,t))}oe.prototype.format=function(n){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<n.length;s++)if(n[s].source===this.location.source){e=n[s].text.split(/\r\n|\n|\r/g);break}var r=this.location.start,o=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(r):r,u=this.location.source+":"+o.line+":"+o.column;if(e){var h=this.location.end,f=Ne("",o.line.toString().length," "),p=e[r.line-1],g=r.line===h.line?h.column:p.length+1,b=g-r.column||1;t+=`
 --> `+u+`
`+f+` |
`+o.line+" | "+p+`
`+f+" | "+Ne("",r.column-1," ")+Ne("",b,"^")}else t+=`
 at `+u}return t};oe.buildMessage=function(n,t){var e={literal:function(p){return'"'+r(p.text)+'"'},class:function(p){var g=p.parts.map(function(b){return Array.isArray(b)?o(b[0])+"-"+o(b[1]):o(b)});return"["+(p.inverted?"^":"")+g.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(p){return p.description}};function s(p){return p.charCodeAt(0).toString(16).toUpperCase()}function r(p){return p.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function o(p){return p.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function u(p){return e[p.type](p)}function h(p){var g=p.map(u),b,_;if(g.sort(),g.length>0){for(b=1,_=1;b<g.length;b++)g[b-1]!==g[b]&&(g[_]=g[b],_++);g.length=_}switch(g.length){case 1:return g[0];case 2:return g[0]+" or "+g[1];default:return g.slice(0,-1).join(", ")+", or "+g[g.length-1]}}function f(p){return p?'"'+r(p)+'"':"end of input"}return"Expected "+h(n)+" but "+f(t)+" found."};function _s(n,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,r={pgn:Je},o=Je,u="[",h='"',f="]",p=".",g="O-O-O",b="O-O",_="0-0-0",P="0-0",E="$",w="{",x="}",B=";",ae="(",z=")",pe="1-0",_e="0-1",de="1/2-1/2",$e="*",le=/^[a-zA-Z]/,N=/^[^"]/,$=/^[0-9]/,O=/^[.]/,I=/^[a-zA-Z1-8\-=]/,Q=/^[+#]/,J=/^[!?]/,L=/^[^}]/,U=/^[^\r\n]/,Z=/^[ \t\r\n]/,ke=G("tag pair"),lt=M("[",!1),De=M('"',!1),ct=M("]",!1),ht=G("tag name"),Ae=V([["a","z"],["A","Z"]],!1,!1),ft=G("tag value"),Ue=V(['"'],!0,!1),ut=G("move number"),ge=V([["0","9"]],!1,!1),pt=M(".",!1),je=V(["."],!1,!1),_t=G("standard algebraic notation"),dt=M("O-O-O",!1),gt=M("O-O",!1),mt=M("0-0-0",!1),vt=M("0-0",!1),Be=V([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),bt=V(["+","#"],!1,!1),St=G("suffix annotation"),Qe=V(["!","?"],!1,!1),Et=G("NAG"),Ct=M("$",!1),yt=G("brace comment"),$t=M("{",!1),He=V(["}"],!0,!1),kt=M("}",!1),At=G("rest of line comment"),wt=M(";",!1),Ge=V(["\r",`
`],!0,!1),Nt=G("variation"),xt=M("(",!1),Tt=M(")",!1),Pt=G("game termination marker"),Ot=M("1-0",!1),It=M("0-1",!1),Lt=M("1/2-1/2",!1),Rt=M("*",!1),Kt=G("whitespace"),We=V([" ","	","\r",`
`],!1,!1),Mt=function(i,l){return us(i,l)},Ft=function(i){return Object.fromEntries(i)},qt=function(i,l){return[i,l]},Dt=function(i,l){return{root:i,marker:l}},Ut=function(i,l){return fs(cs(i),...l.flat())},jt=function(i,l,c,v,S){return hs(i,l,c,v,S)},Bt=function(i){return i},Qt=function(i){return i.replace(/[\r\n]+/g," ")},Ht=function(i){return i.trim()},Gt=function(i){return i},Wt=function(i,l){return{result:i,comment:l}},a=t.peg$currPos|0,ne=[{line:1,column:1}],W=a,me=t.peg$maxFailExpected||[],d=t.peg$silentFails|0,ce;if(t.startRule){if(!(t.startRule in r))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');o=r[t.startRule]}function M(i,l){return{type:"literal",text:i,ignoreCase:l}}function V(i,l,c){return{type:"class",parts:i,inverted:l,ignoreCase:c}}function Vt(){return{type:"end"}}function G(i){return{type:"other",description:i}}function Ve(i){var l=ne[i],c;if(l)return l;if(i>=ne.length)c=ne.length-1;else for(c=i;!ne[--c];);for(l=ne[c],l={line:l.line,column:l.column};c<i;)n.charCodeAt(c)===10?(l.line++,l.column=1):l.column++,c++;return ne[i]=l,l}function Ye(i,l,c){var v=Ve(i),S=Ve(l),k={source:s,start:{offset:i,line:v.line,column:v.column},end:{offset:l,line:S.line,column:S.column}};return k}function m(i){a<W||(a>W&&(W=a,me=[]),me.push(i))}function Yt(i,l,c){return new oe(oe.buildMessage(i,l),i,l,c)}function Je(){var i,l,c;return i=a,l=Jt(),c=Xt(),i=Mt(l,c),i}function Jt(){var i,l,c;for(i=a,l=[],c=ze();c!==e;)l.push(c),c=ze();return c=j(),i=Ft(l),i}function ze(){var i,l,c,v,S,k,se;return d++,i=a,j(),n.charCodeAt(a)===91?(l=u,a++):(l=e,d===0&&m(lt)),l!==e?(j(),c=zt(),c!==e?(j(),n.charCodeAt(a)===34?(v=h,a++):(v=e,d===0&&m(De)),v!==e?(S=Zt(),n.charCodeAt(a)===34?(k=h,a++):(k=e,d===0&&m(De)),k!==e?(j(),n.charCodeAt(a)===93?(se=f,a++):(se=e,d===0&&m(ct)),se!==e?i=qt(c,S):(a=i,i=e)):(a=i,i=e)):(a=i,i=e)):(a=i,i=e)):(a=i,i=e),d--,i===e&&d===0&&m(ke),i}function zt(){var i,l,c;if(d++,i=a,l=[],c=n.charAt(a),le.test(c)?a++:(c=e,d===0&&m(Ae)),c!==e)for(;c!==e;)l.push(c),c=n.charAt(a),le.test(c)?a++:(c=e,d===0&&m(Ae));else l=e;return l!==e?i=n.substring(i,a):i=l,d--,i===e&&(l=e,d===0&&m(ht)),i}function Zt(){var i,l,c;for(d++,i=a,l=[],c=n.charAt(a),N.test(c)?a++:(c=e,d===0&&m(Ue));c!==e;)l.push(c),c=n.charAt(a),N.test(c)?a++:(c=e,d===0&&m(Ue));return i=n.substring(i,a),d--,l=e,d===0&&m(ft),i}function Xt(){var i,l,c;return i=a,l=Ze(),j(),c=ns(),c===e&&(c=null),j(),i=Dt(l,c),i}function Ze(){var i,l,c,v;for(i=a,l=we(),l===e&&(l=null),c=[],v=Xe();v!==e;)c.push(v),v=Xe();return i=Ut(l,c),i}function Xe(){var i,l,c,v,S,k,se,ve;if(i=a,j(),es(),j(),l=ts(),l!==e){for(c=ss(),c===e&&(c=null),v=[],S=et();S!==e;)v.push(S),S=et();for(S=j(),k=we(),k===e&&(k=null),se=[],ve=tt();ve!==e;)se.push(ve),ve=tt();i=jt(l,c,v,k,se)}else a=i,i=e;return i}function es(){var i,l,c,v,S,k;for(d++,i=a,l=[],c=n.charAt(a),$.test(c)?a++:(c=e,d===0&&m(ge));c!==e;)l.push(c),c=n.charAt(a),$.test(c)?a++:(c=e,d===0&&m(ge));if(n.charCodeAt(a)===46?(c=p,a++):(c=e,d===0&&m(pt)),c!==e){for(v=j(),S=[],k=n.charAt(a),O.test(k)?a++:(k=e,d===0&&m(je));k!==e;)S.push(k),k=n.charAt(a),O.test(k)?a++:(k=e,d===0&&m(je));l=[l,c,v,S],i=l}else a=i,i=e;return d--,i===e&&(l=e,d===0&&m(ut)),i}function ts(){var i,l,c,v,S,k;if(d++,i=a,l=a,n.substr(a,5)===g?(c=g,a+=5):(c=e,d===0&&m(dt)),c===e&&(n.substr(a,3)===b?(c=b,a+=3):(c=e,d===0&&m(gt)),c===e&&(n.substr(a,5)===_?(c=_,a+=5):(c=e,d===0&&m(mt)),c===e&&(n.substr(a,3)===P?(c=P,a+=3):(c=e,d===0&&m(vt)),c===e))))if(c=a,v=n.charAt(a),le.test(v)?a++:(v=e,d===0&&m(Ae)),v!==e){if(S=[],k=n.charAt(a),I.test(k)?a++:(k=e,d===0&&m(Be)),k!==e)for(;k!==e;)S.push(k),k=n.charAt(a),I.test(k)?a++:(k=e,d===0&&m(Be));else S=e;S!==e?(v=[v,S],c=v):(a=c,c=e)}else a=c,c=e;return c!==e?(v=n.charAt(a),Q.test(v)?a++:(v=e,d===0&&m(bt)),v===e&&(v=null),c=[c,v],l=c):(a=l,l=e),l!==e?i=n.substring(i,a):i=l,d--,i===e&&(l=e,d===0&&m(_t)),i}function ss(){var i,l,c;for(d++,i=a,l=[],c=n.charAt(a),J.test(c)?a++:(c=e,d===0&&m(Qe));c!==e;)l.push(c),l.length>=2?c=e:(c=n.charAt(a),J.test(c)?a++:(c=e,d===0&&m(Qe)));return l.length<1?(a=i,i=e):i=l,d--,i===e&&(l=e,d===0&&m(St)),i}function et(){var i,l,c,v,S;if(d++,i=a,j(),n.charCodeAt(a)===36?(l=E,a++):(l=e,d===0&&m(Ct)),l!==e){if(c=a,v=[],S=n.charAt(a),$.test(S)?a++:(S=e,d===0&&m(ge)),S!==e)for(;S!==e;)v.push(S),S=n.charAt(a),$.test(S)?a++:(S=e,d===0&&m(ge));else v=e;v!==e?c=n.substring(c,a):c=v,c!==e?i=Bt(c):(a=i,i=e)}else a=i,i=e;return d--,i===e&&d===0&&m(Et),i}function we(){var i;return i=is(),i===e&&(i=rs()),i}function is(){var i,l,c,v,S;if(d++,i=a,n.charCodeAt(a)===123?(l=w,a++):(l=e,d===0&&m($t)),l!==e){for(c=a,v=[],S=n.charAt(a),L.test(S)?a++:(S=e,d===0&&m(He));S!==e;)v.push(S),S=n.charAt(a),L.test(S)?a++:(S=e,d===0&&m(He));c=n.substring(c,a),n.charCodeAt(a)===125?(v=x,a++):(v=e,d===0&&m(kt)),v!==e?i=Qt(c):(a=i,i=e)}else a=i,i=e;return d--,i===e&&(l=e,d===0&&m(yt)),i}function rs(){var i,l,c,v,S;if(d++,i=a,n.charCodeAt(a)===59?(l=B,a++):(l=e,d===0&&m(wt)),l!==e){for(c=a,v=[],S=n.charAt(a),U.test(S)?a++:(S=e,d===0&&m(Ge));S!==e;)v.push(S),S=n.charAt(a),U.test(S)?a++:(S=e,d===0&&m(Ge));c=n.substring(c,a),i=Ht(c)}else a=i,i=e;return d--,i===e&&(l=e,d===0&&m(At)),i}function tt(){var i,l,c,v;return d++,i=a,j(),n.charCodeAt(a)===40?(l=ae,a++):(l=e,d===0&&m(xt)),l!==e?(c=Ze(),c!==e?(j(),n.charCodeAt(a)===41?(v=z,a++):(v=e,d===0&&m(Tt)),v!==e?i=Gt(c):(a=i,i=e)):(a=i,i=e)):(a=i,i=e),d--,i===e&&d===0&&m(Nt),i}function ns(){var i,l,c;return d++,i=a,n.substr(a,3)===pe?(l=pe,a+=3):(l=e,d===0&&m(Ot)),l===e&&(n.substr(a,3)===_e?(l=_e,a+=3):(l=e,d===0&&m(It)),l===e&&(n.substr(a,7)===de?(l=de,a+=7):(l=e,d===0&&m(Lt)),l===e&&(n.charCodeAt(a)===42?(l=$e,a++):(l=e,d===0&&m(Rt))))),l!==e?(j(),c=we(),c===e&&(c=null),i=Wt(l,c)):(a=i,i=e),d--,i===e&&(l=e,d===0&&m(Pt)),i}function j(){var i,l;for(d++,i=[],l=n.charAt(a),Z.test(l)?a++:(l=e,d===0&&m(We));l!==e;)i.push(l),l=n.charAt(a),Z.test(l)?a++:(l=e,d===0&&m(We));return d--,l=e,d===0&&m(Kt),i}if(ce=o(),t.peg$library)return{peg$result:ce,peg$currPos:a,peg$FAILED:e,peg$maxFailExpected:me,peg$maxFailPos:W};if(ce!==e&&a===n.length)return ce;throw ce!==e&&a<n.length&&m(Vt()),Yt(me,W<n.length?n.charAt(W):null,W<n.length?Ye(W,W+1):Ye(W,W))}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const Ee=0xffffffffffffffffn;function xe(n,t){return(n<<t|n>>64n-t)&0xffffffffffffffffn}function st(n,t){return n*t&Ee}function ds(n){return function(){let t=BigInt(n&Ee),e=BigInt(n>>64n&Ee);const s=st(xe(st(t,5n),7n),9n);return e^=t,t=(xe(t,24n)^e^e<<16n)&Ee,e=xe(e,37n),n=e<<64n|t,s}}const ye=ds(0xa187eb39cdcaed8f31c4b365b102e01en),gs=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>ye()))),ms=Array.from({length:8},()=>ye()),vs=Array.from({length:16},()=>ye()),Te=ye(),D="w",H="b",R="p",Me="n",Ce="b",fe="r",te="q",K="k",Pe="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class be{constructor(t,e){T(this,"color");T(this,"from");T(this,"to");T(this,"piece");T(this,"captured");T(this,"promotion");T(this,"flags");T(this,"san");T(this,"lan");T(this,"before");T(this,"after");const{color:s,piece:r,from:o,to:u,flags:h,captured:f,promotion:p}=e,g=F(o),b=F(u);this.color=s,this.piece=r,this.from=g,this.to=b,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=g+b,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(const _ in y)y[_]&h&&(this.flags+=ie[_]);f&&(this.captured=f),p&&(this.promotion=p,this.lan+=p)}isCapture(){return this.flags.indexOf(ie.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(ie.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(ie.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(ie.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(ie.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(ie.BIG_PAWN)>-1}}const q=-1,ie={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},y={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},Fe={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},bs={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Ss={...Fe,...bs},C={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},Oe={b:[16,32,17,15],w:[-16,-32,-17,-15]},it={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Es=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Cs=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],ys={p:1,n:2,b:4,r:8,q:16,k:32},$s="pnbrqkPNBRQK",rt=[Me,Ce,fe,te],ks=7,As=6,ws=1,Ns=0,Se={[K]:y.KSIDE_CASTLE,[te]:y.QSIDE_CASTLE},X={w:[{square:C.a1,flag:y.QSIDE_CASTLE},{square:C.h1,flag:y.KSIDE_CASTLE}],b:[{square:C.a8,flag:y.QSIDE_CASTLE},{square:C.h8,flag:y.KSIDE_CASTLE}]},xs={b:ws,w:As},Ie="--";function re(n){return n>>4}function ue(n){return n&15}function at(n){return"0123456789".indexOf(n)!==-1}function F(n){const t=ue(n),e=re(n);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function he(n){return n===D?H:D}function Ts(n){const t=n.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const r=t[0].split("/");if(r.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let u=0;u<r.length;u++){let h=0,f=!1;for(let p=0;p<r[u].length;p++)if(at(r[u][p])){if(f)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};h+=parseInt(r[u][p],10),f=!0}else{if(!/^[prnbqkPRNBQK]$/.test(r[u][p]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};h+=1,f=!1}if(h!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const o=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:u,regex:h}of o){if(!h.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${u} king`};if((t[0].match(h)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${u} kings`}}return Array.from(r[0]+r[7]).some(u=>u.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Ps(n,t){const e=n.from,s=n.to,r=n.piece;let o=0,u=0,h=0;for(let f=0,p=t.length;f<p;f++){const g=t[f].from,b=t[f].to,_=t[f].piece;r===_&&e!==g&&s===b&&(o++,re(e)===re(g)&&u++,ue(e)===ue(g)&&h++)}return o>0?u>0&&h>0?F(e):h>0?F(e).charAt(1):F(e).charAt(0):""}function ee(n,t,e,s,r,o=void 0,u=y.NORMAL){const h=re(s);if(r===R&&(h===ks||h===Ns))for(let f=0;f<rt.length;f++){const p=rt[f];n.push({color:t,from:e,to:s,piece:r,captured:o,promotion:p,flags:u|y.PROMOTION})}else n.push({color:t,from:e,to:s,piece:r,captured:o,flags:u})}function nt(n){let t=n.charAt(0);return t>="a"&&t<="h"?n.match(/[a-h]\d.*[a-h]\d/)?void 0:R:(t=t.toLowerCase(),t==="o"?K:t)}function Le(n){return n.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class Re{constructor(t=Pe,{skipValidation:e=!1}={}){T(this,"_board",new Array(128));T(this,"_turn",D);T(this,"_header",{});T(this,"_kings",{w:q,b:q});T(this,"_epSquare",-1);T(this,"_halfMoves",0);T(this,"_moveNumber",0);T(this,"_history",[]);T(this,"_comments",{});T(this,"_castling",{w:0,b:0});T(this,"_hash",0n);T(this,"_positionCount",new Map);this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:q,b:q},this._turn=D,this._castling={w:0,b:0},this._epSquare=q,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...Ss},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let r=t.split(/\s+/);if(r.length>=2&&r.length<6){const h=["-","-","0","1"];t=r.concat(h.slice(-(6-r.length))).join(" ")}if(r=t.split(/\s+/),!e){const{ok:h,error:f}=Ts(t);if(!h)throw new Error(f)}const o=r[0];let u=0;this.clear({preserveHeaders:s});for(let h=0;h<o.length;h++){const f=o.charAt(h);if(f==="/")u+=8;else if(at(f))u+=parseInt(f,10);else{const p=f<"a"?D:H;this._put({type:f.toLowerCase(),color:p},F(u)),u++}}this._turn=r[1],r[2].indexOf("K")>-1&&(this._castling.w|=y.KSIDE_CASTLE),r[2].indexOf("Q")>-1&&(this._castling.w|=y.QSIDE_CASTLE),r[2].indexOf("k")>-1&&(this._castling.b|=y.KSIDE_CASTLE),r[2].indexOf("q")>-1&&(this._castling.b|=y.QSIDE_CASTLE),this._epSquare=r[3]==="-"?q:C[r[3]],this._halfMoves=parseInt(r[4],10),this._moveNumber=parseInt(r[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){var u,h;let e=0,s="";for(let f=C.a8;f<=C.h1;f++){if(this._board[f]){e>0&&(s+=e,e=0);const{color:p,type:g}=this._board[f];s+=p===D?g.toUpperCase():g.toLowerCase()}else e++;f+1&136&&(e>0&&(s+=e),f!==C.h1&&(s+="/"),e=0,f+=8)}let r="";this._castling[D]&y.KSIDE_CASTLE&&(r+="K"),this._castling[D]&y.QSIDE_CASTLE&&(r+="Q"),this._castling[H]&y.KSIDE_CASTLE&&(r+="k"),this._castling[H]&y.QSIDE_CASTLE&&(r+="q"),r=r||"-";let o="-";if(this._epSquare!==q)if(t)o=F(this._epSquare);else{const f=this._epSquare+(this._turn===D?16:-16),p=[f+1,f-1];for(const g of p){if(g&136)continue;const b=this._turn;if(((u=this._board[g])==null?void 0:u.color)===b&&((h=this._board[g])==null?void 0:h.type)===R){this._makeMove({color:b,from:g,to:this._epSquare,piece:R,captured:R,flags:y.EP_CAPTURE});const _=!this._isKingAttacked(b);if(this._undoMove(),_){o=F(this._epSquare);break}}}}return[s,this._turn,r,o,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:e,type:s}=this._board[t],r={w:0,b:1}[e],o={p:0,n:1,b:2,r:3,q:4,k:5}[s];return gs[r][o][t]}_epKey(){return this._epSquare===q?0n:ms[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return vs[t]}_computeHash(){let t=0n;for(let e=C.a8;e<=C.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=Te),t}_updateSetup(t){this._history.length>0||(t!==Pe?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(Pe)}get(t){return this._board[C[t]]}findPiece(t){var s;const e=[];for(let r=C.a8;r<=C.h1;r++){if(r&136){r+=7;continue}!this._board[r]||((s=this._board[r])==null?void 0:s.color)!==t.color||this._board[r].color===t.color&&this._board[r].type===t.type&&e.push(F(r))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if($s.indexOf(t.toLowerCase())===-1||!(s in C))return!1;const r=C[s];if(t==K&&!(this._kings[e]==q||this._kings[e]==r))return!1;const o=this._board[r];return o&&o.type===K&&(this._kings[o.color]=q),this._set(r,{type:t,color:e}),t===K&&(this._kings[e]=r),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const e=this.get(t);return this._clear(C[t]),e&&e.type===K&&(this._kings[e.color]=q),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){var s,r,o,u,h,f,p,g,b,_,P,E;this._hash^=this._castlingKey();const t=((s=this._board[C.e1])==null?void 0:s.type)===K&&((r=this._board[C.e1])==null?void 0:r.color)===D,e=((o=this._board[C.e8])==null?void 0:o.type)===K&&((u=this._board[C.e8])==null?void 0:u.color)===H;(!t||((h=this._board[C.a1])==null?void 0:h.type)!==fe||((f=this._board[C.a1])==null?void 0:f.color)!==D)&&(this._castling.w&=-65),(!t||((p=this._board[C.h1])==null?void 0:p.type)!==fe||((g=this._board[C.h1])==null?void 0:g.color)!==D)&&(this._castling.w&=-33),(!e||((b=this._board[C.a8])==null?void 0:b.type)!==fe||((_=this._board[C.a8])==null?void 0:_.color)!==H)&&(this._castling.b&=-65),(!e||((P=this._board[C.h8])==null?void 0:P.type)!==fe||((E=this._board[C.h8])==null?void 0:E.color)!==H)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){var o,u;if(this._epSquare===q)return;const t=this._epSquare+(this._turn===D?-16:16),e=this._epSquare+(this._turn===D?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||((o=this._board[e])==null?void 0:o.color)!==he(this._turn)||((u=this._board[e])==null?void 0:u.type)!==R){this._hash^=this._epKey(),this._epSquare=q;return}const r=h=>{var f,p;return!(h&136)&&((f=this._board[h])==null?void 0:f.color)===this._turn&&((p=this._board[h])==null?void 0:p.type)===R};s.some(r)||(this._hash^=this._epKey(),this._epSquare=q)}_attacked(t,e,s){const r=[];for(let o=C.a8;o<=C.h1;o++){if(o&136){o+=7;continue}if(this._board[o]===void 0||this._board[o].color!==t)continue;const u=this._board[o],h=o-e;if(h===0)continue;const f=h+119;if(Es[f]&ys[u.type]){if(u.type===R){if(h>0&&u.color===D||h<=0&&u.color===H)if(s)r.push(F(o));else return!0;continue}if(u.type==="n"||u.type==="k")if(s){r.push(F(o));continue}else return!0;const p=Cs[f];let g=o+p,b=!1;for(;g!==e;){if(this._board[g]!=null){b=!0;break}g+=p}if(!b)if(s){r.push(F(o));continue}else return!0}}return s?r:!1}attackers(t,e){return e?this._attacked(e,C[t],!0):this._attacked(this._turn,C[t],!0)}_isKingAttacked(t){const e=this._kings[t];return e===-1?!1:this._attacked(he(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,C[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},e=[];let s=0,r=0;for(let o=C.a8;o<=C.h1;o++){if(r=(r+1)%2,o&136){o+=7;continue}const u=this._board[o];u&&(t[u.type]=u.type in t?t[u.type]+1:1,u.type===Ce&&e.push(r),s++)}if(s===2)return!0;if(s===3&&(t[Ce]===1||t[Me]===1))return!0;if(s===t[Ce]+2){let o=0;const u=e.length;for(let h=0;h<u;h++)o+=e[h];if(o===0||o===u)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){const r=this._moves({square:e,piece:s});return t?r.map(o=>new be(this,o)):r.map(o=>this._moveToSan(o,r))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){var P;const r=s?s.toLowerCase():void 0,o=e==null?void 0:e.toLowerCase(),u=[],h=this._turn,f=he(h);let p=C.a8,g=C.h1,b=!1;if(r)if(r in C)p=g=C[r],b=!0;else return[];for(let E=p;E<=g;E++){if(E&136){E+=7;continue}if(!this._board[E]||this._board[E].color===f)continue;const{type:w}=this._board[E];let x;if(w===R){if(o&&o!==w)continue;x=E+Oe[h][0],this._board[x]||(ee(u,h,E,x,R),x=E+Oe[h][1],xs[h]===re(E)&&!this._board[x]&&ee(u,h,E,x,R,void 0,y.BIG_PAWN));for(let B=2;B<4;B++)x=E+Oe[h][B],!(x&136)&&(((P=this._board[x])==null?void 0:P.color)===f?ee(u,h,E,x,R,this._board[x].type,y.CAPTURE):x===this._epSquare&&ee(u,h,E,x,R,R,y.EP_CAPTURE))}else{if(o&&o!==w)continue;for(let B=0,ae=it[w].length;B<ae;B++){const z=it[w][B];for(x=E;x+=z,!(x&136);){if(!this._board[x])ee(u,h,E,x,w);else{if(this._board[x].color===h)break;ee(u,h,E,x,w,this._board[x].type,y.CAPTURE);break}if(w===Me||w===K)break}}}}if((o===void 0||o===K)&&(!b||g===this._kings[h])){if(this._castling[h]&y.KSIDE_CASTLE){const E=this._kings[h],w=E+2;!this._board[E+1]&&!this._board[w]&&!this._attacked(f,this._kings[h])&&!this._attacked(f,E+1)&&!this._attacked(f,w)&&ee(u,h,this._kings[h],w,K,void 0,y.KSIDE_CASTLE)}if(this._castling[h]&y.QSIDE_CASTLE){const E=this._kings[h],w=E-2;!this._board[E-1]&&!this._board[E-2]&&!this._board[E-3]&&!this._attacked(f,this._kings[h])&&!this._attacked(f,E-1)&&!this._attacked(f,w)&&ee(u,h,this._kings[h],w,K,void 0,y.QSIDE_CASTLE)}}if(!t||this._kings[h]===-1)return u;const _=[];for(let E=0,w=u.length;E<w;E++)this._makeMove(u[E]),this._isKingAttacked(h)||_.push(u[E]),this._undoMove();return _}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(Ie,e);else if(typeof t=="object"){const o=this._moves();for(let u=0,h=o.length;u<h;u++)if(t.from===F(o[u].from)&&t.to===F(o[u].to)&&(!("promotion"in o[u])||t.promotion===o[u].promotion)){s=o[u];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&y.NULL_MOVE)throw new Error("Null move not allowed when in check");const r=new be(this,s);return this._makeMove(s),this._incPositionCount(),r}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){var r,o,u,h;const e=this._turn,s=he(e);if(this._push(t),t.flags&y.NULL_MOVE){e===H&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=q;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&y.EP_CAPTURE&&(this._turn===H?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===K){if(this._kings[e]=t.to,t.flags&y.KSIDE_CASTLE){const f=t.to-1,p=t.to+1;this._movePiece(p,f)}else if(t.flags&y.QSIDE_CASTLE){const f=t.to+1,p=t.to-2;this._movePiece(p,f)}this._castling[e]=0}if(this._castling[e]){for(let f=0,p=X[e].length;f<p;f++)if(t.from===X[e][f].square&&this._castling[e]&X[e][f].flag){this._castling[e]^=X[e][f].flag;break}}if(this._castling[s]){for(let f=0,p=X[s].length;f<p;f++)if(t.to===X[s][f].square&&this._castling[s]&X[s][f].flag){this._castling[s]^=X[s][f].flag;break}}if(this._hash^=this._castlingKey(),t.flags&y.BIG_PAWN){let f;e===H?f=t.to-16:f=t.to+16,!(t.to-1&136)&&((r=this._board[t.to-1])==null?void 0:r.type)===R&&((o=this._board[t.to-1])==null?void 0:o.color)===s||!(t.to+1&136)&&((u=this._board[t.to+1])==null?void 0:u.type)===R&&((h=this._board[t.to+1])==null?void 0:h.color)===s?(this._epSquare=f,this._hash^=this._epKey()):this._epSquare=q}else this._epSquare=q;t.piece===R?this._halfMoves=0:t.flags&(y.CAPTURE|y.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===H&&this._moveNumber++,this._turn=s,this._hash^=Te}undo(){const t=this._hash,e=this._undoMove();if(e){const s=new be(this,e);return this._decPositionCount(t),s}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=Te;const s=this._turn,r=he(s);if(e.flags&y.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&y.EP_CAPTURE){let o;s===H?o=e.to-16:o=e.to+16,this._set(o,{type:R,color:r})}else this._set(e.to,{type:e.captured,color:r});if(e.flags&(y.KSIDE_CASTLE|y.QSIDE_CASTLE)){let o,u;e.flags&y.KSIDE_CASTLE?(o=e.to+1,u=e.to-1):(o=e.to-2,u=e.to+1),this._movePiece(u,o)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){const s=[];let r=!1;for(const _ in this._header)this._header[_]&&s.push(`[${_} "${this._header[_]}"]`+t),r=!0;r&&this._history.length&&s.push(t);const o=_=>{const P=this._comments[this.fen()];if(typeof P<"u"){const E=_.length>0?" ":"";_=`${_}${E}{${P}}`}return _},u=[];for(;this._history.length>0;)u.push(this._undoMove());const h=[];let f="";for(u.length===0&&h.push(o(""));u.length>0;){f=o(f);const _=u.pop();if(!_)break;if(!this._history.length&&_.color==="b"){const P=`${this._moveNumber}. ...`;f=f?`${f} ${P}`:P}else _.color==="w"&&(f.length&&h.push(f),f=this._moveNumber+".");f=f+" "+this._moveToSan(_,this._moves({legal:!0})),this._makeMove(_)}if(f.length&&h.push(o(f)),h.push(this._header.Result||"*"),e===0)return s.join("")+h.join(" ");const p=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},g=function(_,P){for(const E of P.split(" "))if(E){if(_+E.length>e){for(;p();)_--;s.push(t),_=0}s.push(E),_+=E.length,s.push(" "),_++}return p()&&_--,_};let b=0;for(let _=0;_<h.length;_++){if(b+h[_].length>e&&h[_].includes("{")){b=g(b,h[_]);continue}b+h[_].length>e&&_!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),b=0):_!==0&&(s.push(" "),b++),s.push(h[_]),b+=h[_].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??Fe[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=Fe[t]||null,!0):!1}getHeaders(){const t={};for(const[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));const r=_s(t);this.reset();const o=r.headers;let u="";for(const p in o)p.toLowerCase()==="fen"&&(u=o[p]),this.header(p,o[p]);if(!e)u&&this.load(u,{preserveHeaders:!0});else if(o.SetUp==="1"){if(!("FEN"in o))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(o.FEN,{preserveHeaders:!0})}let h=r.root;for(;h;){if(h.move){const p=this._moveFromSan(h.move,e);if(p==null)throw new Error(`Invalid move in PGN: ${h.move}`);this._makeMove(p),this._incPositionCount()}h.comment!==void 0&&(this._comments[this.fen()]=h.comment),h=h.variations[0]}const f=r.result;f&&Object.keys(this._header).length&&this._header.Result!==f&&this.setHeader("Result",f)}_moveToSan(t,e){let s="";if(t.flags&y.KSIDE_CASTLE)s="O-O";else if(t.flags&y.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&y.NULL_MOVE)return Ie;if(t.piece!==R){const r=Ps(t,e);s+=t.piece.toUpperCase()+r}t.flags&(y.CAPTURE|y.EP_CAPTURE)&&(t.piece===R&&(s+=F(t.from)[0]),s+="x"),s+=F(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=Le(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==Ie)return{color:this._turn,from:0,to:0,piece:"k",flags:y.NULL_MOVE};let r=nt(s),o=this._moves({legal:!0,piece:r});for(let _=0,P=o.length;_<P;_++)if(s===Le(this._moveToSan(o[_],o)))return o[_];if(e)return null;let u,h,f,p,g,b=!1;if(h=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),h?(u=h[1],f=h[2],p=h[3],g=h[4],f.length==1&&(b=!0)):(h=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),h&&(u=h[1],f=h[2],p=h[3],g=h[4],f.length==1&&(b=!0))),r=nt(s),o=this._moves({legal:!0,piece:u||r}),!p)return null;for(let _=0,P=o.length;_<P;_++)if(f){if((!u||u.toLowerCase()==o[_].piece)&&C[f]==o[_].from&&C[p]==o[_].to&&(!g||g.toLowerCase()==o[_].promotion))return o[_];if(b){const E=F(o[_].from);if((!u||u.toLowerCase()==o[_].piece)&&C[p]==o[_].to&&(f==E[0]||f==E[1])&&(!g||g.toLowerCase()==o[_].promotion))return o[_]}}else if(s===Le(this._moveToSan(o[_],o)).replace("x",""))return o[_];return null}ascii(){let t=`   +------------------------+
`;for(let e=C.a8;e<=C.h1;e++){if(ue(e)===0&&(t+=" "+"87654321"[re(e)]+" |"),this._board[e]){const s=this._board[e].type,o=this._board[e].color===D?s.toUpperCase():s.toLowerCase();t+=" "+o+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const e=this._moves({legal:!1});let s=0;const r=this._turn;for(let o=0,u=e.length;o<u;o++)this._makeMove(e[o]),this._isKingAttacked(r)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let e=[];for(let s=C.a8;s<=C.h1;s++)this._board[s]==null?e.push(null):e.push({square:F(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in C){const e=C[t];return(re(e)+ue(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){const r=e.pop();if(!r)break;t?s.push(new be(this,r)):s.push(this._moveToSan(r,this._moves())),this._makeMove(r)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){const t=[],e={},s=r=>{r in this._comments&&(e[r]=this._comments[r])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){const r=t.pop();if(!r)break;this._makeMove(r),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(const r of[K,te])e[r]!==void 0&&(e[r]?this._castling[t]|=Se[r]:this._castling[t]&=~Se[r]);this._updateCastlingRights();const s=this.getCastlingRights(t);return(e[K]===void 0||e[K]===s[K])&&(e[te]===void 0||e[te]===s[te])}getCastlingRights(t){return{[K]:(this._castling[t]&Se[K])!==0,[te]:(this._castling[t]&Se[te])!==0}}moveNumber(){return this._moveNumber}}const Os="start";function Is(n){try{return btoa(unescape(encodeURIComponent(n))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}catch{return""}}function Ls(n){try{let t=(n||"").replace(/-/g,"+").replace(/_/g,"/");const e=t.length%4;return e&&(t+="=".repeat(4-e)),decodeURIComponent(escape(atob(t)))}catch{return""}}const ot={p:"♟",r:"♜",n:"♞",b:"♝",q:"♛",k:"♚",P:"♙",R:"♖",N:"♘",B:"♗",Q:"♕",K:"♔"};function Rs(){try{const n=JSON.parse(localStorage.getItem("user"));return(n==null?void 0:n.id)||(n==null?void 0:n._id)||null}catch{return null}}function qe(){const n=Rs();return n?`chess_state_${n}`:"chess_state_guest"}function Ks(){const n=localStorage.getItem(qe());if(!n)return null;try{const t=JSON.parse(n);return(t==null?void 0:t.fen)||null}catch{return null}}function Ke(n){try{localStorage.setItem(qe(),JSON.stringify({fen:n,savedAt:Date.now()}))}catch(t){console.warn("Cannot save chess state:",t)}}function Ms(){localStorage.removeItem(qe())}const Ds=()=>{const n="game",t=ls(),[e,s]=Y.useState(()=>new Re),[r,o]=Y.useState(null),[u,h]=Y.useState([]),[f,p]=Y.useState("w"),[g,b]=Y.useState(""),[_,P]=Y.useState(!1),E=Y.useRef(null),w=N=>{const $={fen:N,t:Date.now()},O=Is(JSON.stringify($)),I=new URL(window.location.href);return I.searchParams.set(n,O),I.toString()},[x,B]=Y.useState("");Y.useEffect(()=>{const N=new Re,O=new URL(window.location.href).searchParams.get(n);let I=null;if(O){const L=Ls(O);try{const U=JSON.parse(L);U!=null&&U.fen&&(I=U.fen)}catch{console.warn("Invalid game URL payload")}}const Q=Ks(),J=I||Q;try{J&&J!==Os&&N.load(J)}catch{console.warn("Invalid saved chess FEN. Starting new game.")}if(s(N),p(N.turn()),z(N),Ke(N.fen()),B(w(N.fen())),!O){const L=w(N.fen());window.history.replaceState({},"",L)}},[]);const ae=Y.useMemo(()=>e.board(),[e,f]),z=N=>{const $=N.isCheckmate(),O=N.isDraw();P($||O),$?b(`Шах-мат! ${N.turn()==="w"?"Черните":"Белите"} печелят.`):O?b("Равенство."):N.isCheck()?b(`${N.turn()==="w"?"Бели":"Черни"} са на ход — Шах!`):b(`${N.turn()==="w"?"Бели":"Черни"} са на ход.`)},pe=(N,$)=>{const O="abcdefgh"[N],I=8-$,Q=`${O}${I}`;if(!r){const L=e.get(Q);if(L&&L.color===e.turn()){const U=e.moves({square:Q,verbose:!0});o(Q),h(U.map(Z=>Z.to))}else o(null),h([]);return}if(r===Q){o(null),h([]);return}if(e.move({from:r,to:Q,promotion:"q"})){o(null),h([]),p(e.turn());const L=e.fen();Ke(L),B(w(L)),window.history.replaceState({},"",w(L)),z(e)}else{const L=e.get(Q);if(L&&L.color===e.turn()){const U=e.moves({square:Q,verbose:!0});o(Q),h(U.map(Z=>Z.to))}else o(null),h([])}},_e=()=>{if(!window.confirm("Сигурни ли сте, че искате да рестартирате играта?"))return;const $=new Re;s($),p($.turn()),o(null),h([]),Ms(),z($),new URL(window.location.href).searchParams.delete(n);const I=w($.fen());B(I),window.history.replaceState({},"",I)},de=()=>{if(!e.undo())return;o(null),h([]),p(e.turn());const $=e.fen();Ke($),B(w($)),window.history.replaceState({},"",w($)),z(e)},$e=async()=>{try{await navigator.clipboard.writeText(x),alert("Линкът е копиран в клипборда!")}catch{try{const $=document.createElement("textarea");$.value=x,document.body.appendChild($),$.select(),document.execCommand("copy"),document.body.removeChild($),alert("Линкът е копиран в клипборда!")}catch{alert("Копирането не бе успешно. Моля, копирайте ръчно.")}}},le=()=>t("/home");return A.jsxs("div",{className:"chess-page",children:[A.jsxs("div",{className:"chess-header",children:[A.jsx("h2",{children:"Шах"}),A.jsxs("div",{className:"chess-actions",children:[A.jsx("button",{className:"btn-secondary",onClick:le,children:"← Назад"}),A.jsx("button",{className:"btn-secondary",onClick:de,disabled:e.history().length===0,title:"Отмени последния ход",children:"↶ Отмени ход"}),A.jsx("button",{className:"btn-danger",onClick:_e,children:"Рестартирай"})]})]}),A.jsxs("div",{className:"chess-container",children:[A.jsx("div",{className:"board",ref:E,children:ae.map((N,$)=>A.jsx("div",{className:"rank",children:N.map((O,I)=>{const Q=($+I)%2===1,J="abcdefgh"[I],L=8-$,U=`${J}${L}`,Z=r===U,ke=u.includes(U);return A.jsxs("div",{className:`square ${Q?"dark":"light"} ${Z?"selected":""} ${ke?"legal":""}`,onClick:()=>pe(I,$),children:[O&&A.jsx("span",{className:`piece ${O.color==="w"?"white":"black"}`,children:ot[O.type===O.type.toLowerCase(),O.type]||ot[O.type]||""}),I===0&&A.jsx("div",{className:"coord rank-label",children:L}),$===7&&A.jsx("div",{className:"coord file-label",children:"abcdefgh"[I]})]},I)})},$))}),A.jsxs("div",{className:"side-panel",children:[A.jsxs("div",{className:"status-card",children:[A.jsx("h3",{children:"Статус"}),A.jsx("p",{children:g}),_&&A.jsx("p",{className:"game-over",children:"Играта е приключила."})]}),A.jsxs("div",{className:"legend-card",children:[A.jsx("h3",{children:"Легенда"}),A.jsx("p",{children:"Кликнете върху фигура, след това върху желано поле. Валидните ходове са подчертани."})]}),A.jsxs("div",{className:"status-card",children:[A.jsx("h3",{children:"Продължи на друг браузър"}),A.jsx("p",{children:"Използвайте този линк, за да отворите играта на друг браузър/устройство (без бекенд):"}),A.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center"},children:[A.jsx("input",{type:"text",readOnly:!0,value:x,onFocus:N=>N.target.select(),style:{flex:1,padding:"8px",borderRadius:"8px",border:"1px solid #ddd"}}),A.jsx("button",{className:"btn-secondary",onClick:$e,title:"Копирай линка",children:"Копирай"})]}),A.jsx("small",{children:"Линкът се обновява автоматично след всеки ход."})]})]})]})]})};export{Ds as default};
